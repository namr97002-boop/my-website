<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | نظام إدارة مياه السوفعي المتقدم</title>
    
    <meta name="theme-color" content="#0077b6"/>
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/assets/icons/icon-192x192.png">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" crossorigin="anonymous"></script>

    <style>
        :root {
            --primary: #0077b6;
            --secondary: #00b4d8;
            --accent: #90e0ef;
            --background: #f8f9fa;
            --card-bg: #ffffff;
            --text-dark: #212529;
            --text-light: #6c757d;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;
            --ai-color: #6f42c1;
            --focus-color: #ff6b6b;
            --border-radius: 10px;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            --col-a-bg: #f1f8ff;
            --col-b-bg: #e3f2fd;
            --col-b-text: #005580;
            --active-row-bg: #fffbe6;
        }

        /* Dark Mode Support */
        @media (prefers-color-scheme: dark) {
            :root {
                --background: #121212;
                --card-bg: #1e1e1e;
                --text-dark: #e9ecef;
                --text-light: #adb5bd;
                --col-a-bg: #2c3e50;
                --col-b-bg: #34495e;
                --col-b-text: #74b9ff;
                --active-row-bg: #2d3436;
                --focus-color: #ff9e9e;
                --shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            }
            
            .metric-card {
                border-right: 5px solid var(--primary);
                border-left: none;
            }
            
            table {
                color: var(--text-dark);
            }
            
            .monthly-report-table-container {
                background-color: var(--card-bg);
                color: var(--text-dark);
            }
        }

        /* High Contrast Mode */
        body.high-contrast {
            --background: #000000;
            --card-bg: #111111;
            --text-dark: #ffffff;
            --text-light: #cccccc;
            --primary: #00b4d8;
            --secondary: #90e0ef;
            --focus-color: #ff0000;
            --col-a-bg: #222222;
            --col-b-bg: #333333;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--background);
            color: var(--text-dark);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            transition: background-color 0.3s, color 0.3s;
        }

        .dashboard-layout {
            display: flex;
            width: 100%;
        }

        .sidebar {
            width: 280px;
            min-height: 100vh;
            background-color: var(--primary);
            color: white;
            padding: 20px;
            box-shadow: 5px 0 15px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            display: flex;
            flex-direction: column;
            gap: 20px;
            transition: all 0.3s;
        }

        .logo h2 {
            font-size: 1.6rem;
            font-weight: 800;
            margin-bottom: 30px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-group-sidebar label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 0.95rem;
            color: var(--accent);
        }

        .sidebar select,
        .sidebar button {
            width: 100%;
            padding: 12px;
            border-radius: var(--border-radius);
            border: none;
            font-family: 'Tajawal', sans-serif;
            font-size: 16px;
            margin-bottom: 15px;
            transition: var(--transition);
        }

        .sidebar select {
            background-color: rgba(255, 255, 255, 0.9);
            color: var(--text-dark);
        }

        .sidebar button {
            background-color: var(--secondary);
            color: white;
            cursor: pointer;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .sidebar button:hover:not(:disabled) {
            background-color: #0096c7;
            transform: scale(1.02);
        }

        .sidebar button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .sidebar #toggleLateBalancesBtn {
            background-color: var(--warning);
            color: var(--text-dark);
        }

        .sidebar #toggleLateBalancesBtn.active {
            background-color: var(--success);
            color: white;
        }

        .main-content {
            flex-grow: 1;
            padding: 30px;
            display: flex;
            flex-direction: column;
            gap: 25px;
            overflow-x: hidden;
        }

        .header-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .search-container {
            position: relative;
            width: 350px;
            max-width: 100%;
        }

        .search-container input {
            width: 100%;
            padding: 12px 20px 12px 50px;
            border-radius: var(--border-radius);
            border: 1px solid #ced4da;
            font-family: 'Tajawal', sans-serif;
            font-size: 1rem;
            transition: border-color 0.3s;
            background-color: var(--card-bg);
            color: var(--text-dark);
        }

        .search-container input:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 119, 182, 0.15);
        }

        .search-container i {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
        }

        .status-indicator {
            padding: 10px 15px;
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            font-size: 0.9rem;
            color: var(--text-dark);
            width: fit-content;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .status-indicator .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: var(--text-light);
            transition: background-color 0.5s;
        }

        .status-indicator.saving .status-dot {
            background-color: var(--warning);
            animation: pulse 1s infinite alternate;
        }

        .status-indicator.saved .status-dot {
            background-color: var(--success);
        }

        .status-indicator.error .status-dot {
            background-color: var(--danger);
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.4);
            }
            100% {
                box-shadow: 0 0 0 8px rgba(255, 193, 7, 0);
            }
        }

        .key-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .metric-card {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-right: 5px solid var(--primary);
            transition: transform 0.3s, background-color 0.3s;
        }

        .metric-card:hover {
            transform: translateY(-5px);
        }

        .metric-card.paid-metric {
            border-right-color: var(--info);
        }

        .metric-card.paid-metric .metric-icon {
            color: var(--info) !important;
        }

        .metric-icon {
            font-size: 2rem;
            color: var(--primary);
            opacity: 0.6;
        }

        .metric-info h3 {
            font-size: 1rem;
            color: var(--text-light);
            font-weight: 500;
        }

        .metric-info p {
            font-size: 1.8rem;
            font-weight: 700;
            margin-top: 5px;
            direction: ltr;
        }

        .data-section {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            transition: background-color 0.3s;
        }
        
        #aiAnalysisSection {
            background-color: var(--card-bg);
            border-right: 5px solid var(--ai-color);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            display: none;
            animation: fadeIn 0.5s ease-out;
            transition: background-color 0.3s;
        }

        #aiAnalysisContent {
            line-height: 1.8;
            color: var(--text-dark);
        }

        #aiAnalysisContent h3 {
            color: var(--ai-color);
            border-bottom: 2px solid var(--accent);
            padding-bottom: 5px;
            margin-top: 15px;
        }

        #aiAnalysisContent ul {
            list-style: none;
            padding-right: 0;
            margin-top: 10px;
        }
        #aiAnalysisContent ul li {
            background: #f4f2ff;
            padding: 10px;
            margin-bottom: 5px;
            border-right: 3px solid var(--ai-color);
            border-radius: 5px;
            font-weight: 500;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .table-container {
            overflow-x: auto;
            max-height: 55vh;
            border-radius: var(--border-radius);
            overflow-y: scroll;
            position: relative;
        }

        table {
            border-collapse: separate;
            border-spacing: 0;
            width: 100%;
            min-width: 1400px;
            transition: color 0.3s;
        }

        th,
        td {
            padding: 14px 12px;
            text-align: center;
            border: 1px solid #e0e0e0;
            font-size: 0.95rem;
            position: relative;
            transition: background-color 0.3s;
        }

        th {
            background-color: var(--primary);
            color: white;
            position: sticky;
            top: 0;
            font-weight: 600;
            z-index: 10;
        }

        th:nth-child(1),
        td:nth-child(1) {
            position: sticky;
            left: 0;
            z-index: 12;
            background-color: var(--col-a-bg) !important;
            box-shadow: 2px 0 3px rgba(0, 0, 0, 0.1);
        }

        th:nth-child(2),
        td:nth-child(2) {
            position: sticky;
            left: 80px;
            z-index: 12;
            background-color: var(--col-b-bg) !important;
            box-shadow: 2px 0 3px rgba(0, 0, 0, 0.1);
            text-align: right;
        }

        th:nth-child(1),
        th:nth-child(2) {
            background-color: var(--primary) !important;
            z-index: 15;
        }

        tr.total-row td {
            background-color: #ffe0b2 !important;
            font-weight: 800;
            color: #e65100 !important;
            border-top: 3px solid var(--danger);
            font-size: 1.05rem;
            position: sticky;
            bottom: 0;
            z-index: 15;
        }

        tr.total-row td:nth-child(1),
        tr.total-row td:nth-child(2) {
            background-color: #ffe0b2 !important;
            z-index: 16;
        }

        td.name-cell {
            text-align: right;
            font-weight: 700;
            color: var(--col-b-text) !important;
        }

        td.number-cell {
            direction: ltr;
        }

        .editable {
            border: 2px solid var(--warning);
            cursor: text;
            transition: box-shadow 0.2s, background-color 0.2s;
        }

        .editable:focus {
            box-shadow: 0 0 5px var(--success);
            border: 2px solid var(--success);
            outline: none;
            background-color: #f1fff1 !important;
        }

        tr.active-row {
            background-color: var(--active-row-bg) !important;
            border-right: 4px solid var(--warning);
        }
        
        /* وضع التركيز الجديد */
        tr.focus-row {
            background-color: rgba(255, 107, 107, 0.15) !important;
            border-right: 4px solid var(--focus-color) !important;
            animation: focusPulse 2s infinite;
            position: relative;
        }
        
        tr.focus-row::after {
            content: "✓";
            position: absolute;
            left: 5px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--focus-color);
            font-weight: bold;
        }
        
        @keyframes focusPulse {
            0% { border-right-color: var(--focus-color); }
            50% { border-right-color: rgba(255, 107, 107, 0.5); }
            100% { border-right-color: var(--focus-color); }
        }

        .alert-section {
            background-color: #ffe5e5;
            border-right: 5px solid var(--danger);
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            color: var(--text-dark);
            display: none;
            transition: background-color 0.3s;
        }

        .alert-section ul {
            margin-top: 10px;
            margin-right: 20px;
            list-style: disc;
        }

        .alert-section ul li.error-item {
            color: var(--danger);
        }

        .alert-section ul li.warning-item {
            color: #e65100;
        }

        .save-notification {
            position: fixed;
            bottom: 220px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background-color: var(--success);
            color: white;
            padding: 15px 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            opacity: 0;
            visibility: hidden;
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
        }

        .save-notification.show {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
        }

        .save-notification.error {
            background-color: var(--danger);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        #onlineStatus {
            position: fixed;
            top: 15px;
            left: 20px;
            padding: 8px 15px;
            border-radius: 50px;
            font-weight: 700;
            color: white;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            font-size: 0.85rem;
            transition: background-color 0.3s;
        }

        .online {
            background-color: var(--success);
        }

        .offline {
            background-color: var(--danger);
        }

        .sync-indicator {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary);
            color: white;
            padding: 15px 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            z-index: 10000;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s ease-out;
            font-weight: 700;
        }

        .sync-badge {
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            margin-right: 5px;
        }

        @keyframes slideIn {
            from {
                transform: translateX(-50%) translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
            to {
                transform: translateX(-50%) translateY(100%);
                opacity: 0;
            }
        }

        .pending-cell {
            border: 2px dashed var(--warning) !important;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 5px,
                rgba(255, 193, 7, 0.1) 5px,
                rgba(255, 193, 7, 0.1) 10px
            ) !important;
            transition: none;
        }

        .synced-cell {
            animation: highlightSuccess 1s ease-out;
        }

        @keyframes highlightSuccess {
            0% {
                background-color: #d4edda;
            }
            100% {
                background-color: transparent;
            }
        }

        /* تنسيقات تقرير القرى الشهري */
        .monthly-report-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 10px;
            padding-bottom: 80px;
        }
        
        .monthly-report-header {
            background: linear-gradient(135deg, #2c3e50, #4a6491);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .monthly-report-header h1 {
            font-size: 1.8rem;
            margin-bottom: 8px;
        }
        
        .monthly-report-subtitle {
            font-size: 1rem;
            opacity: 0.9;
            margin-bottom: 15px;
        }
        
        .monthly-report-stats {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }
        
        .monthly-report-stat-box {
            background-color: rgba(255, 255, 255, 0.15);
            padding: 12px 18px;
            border-radius: 8px;
            text-align: center;
            min-width: 140px;
            backdrop-filter: blur(10px);
        }
        
        .monthly-report-stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .monthly-report-stat-label {
            font-size: 0.9rem;
            opacity: 0.85;
        }
        
        .monthly-report-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            background-color: var(--card-bg);
            padding: 18px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }
        
        .monthly-report-month-selector {
            display: flex;
            justify-content: start; 
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }
        
        .monthly-report-month-btn {
            padding: 10px 18px;
            background-color: #e9ecef;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .monthly-report-month-btn:hover {
            background-color: #d0d7e2;
            transform: translateY(-2px);
        }
        
        .monthly-report-month-btn.active {
            background-color: #4a6491;
            color: white;
        }
        
        .monthly-report-month-btn.total {
            background-color: #2c3e50;
            color: white;
        }
        
        .monthly-report-search-box {
            position: relative;
            flex-grow: 1;
            max-width: 300px;
        }
        
        .monthly-report-search-box input {
            width: 100%;
            padding: 12px 45px 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            background-color: var(--card-bg);
            color: var(--text-dark);
        }
        
        .monthly-report-search-box i {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #777;
        }
        
        .monthly-report-table-container {
            background-color: var(--card-bg);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 25px;
            overflow-x: auto;
        }
        
        .monthly-report-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        
        .monthly-report-table thead {
            background-color: #4a6491;
            color: white;
        }
        
        .monthly-report-table th {
            padding: 18px 12px;
            text-align: center;
            font-weight: 600;
            white-space: nowrap;
        }
        
        .monthly-report-table tbody tr {
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s;
        }
        
        .monthly-report-table tbody tr:hover {
            background-color: #f9fafc;
        }
        
        .monthly-report-table tbody tr:last-child {
            border-bottom: none;
            font-weight: bold;
            background-color: #f8f9fa;
        }
        
        .monthly-report-table td {
            padding: 15px 12px;
            text-align: center;
            border-right: 1px solid #f0f0f0;
        }
        
        .monthly-report-table td:last-child {
            border-right: none;
        }
        
        .monthly-report-positive {
            color: #28a745;
            font-weight: bold;
        }
        
        .monthly-report-negative {
            color: #dc3545;
            font-weight: bold;
        }
        
        .monthly-report-highlight {
            background-color: #fff9e6 !important;
        }
        
        .monthly-report-month-title {
            text-align: center;
            padding: 15px;
            background-color: #f8f9fa;
            border-bottom: 1px solid #eee;
            font-size: 1.3rem;
            color: #2c3e50;
            font-weight: bold;
        }
        
        .monthly-report-no-data {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
            font-size: 1.1rem;
        }
        
        .monthly-report-data-source {
            font-size: 0.85rem;
            color: #6c757d;
            text-align: center;
            margin-top: 10px;
        }
        
        .monthly-report-mobile-warning {
            display: none;
            background-color: #fff3cd;
            color: #856404;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            border: 1px solid #ffeaa7;
        }

        /* تبويب للتبديل بين الميزات */
        .feature-tabs {
            display: flex;
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            overflow: hidden;
            margin-bottom: 25px;
            box-shadow: var(--shadow);
        }

        .tab-button {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: none;
            border: none;
            font-family: 'Tajawal', sans-serif;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            color: var(--text-light);
        }

        .tab-button:hover {
            background-color: rgba(0, 119, 182, 0.1);
        }

        .tab-button.active {
            background-color: var(--primary);
            color: white;
            box-shadow: inset 0 -3px 0 white;
        }

        .feature-content {
            display: none;
        }

        .feature-content.active {
            display: block;
        }

        /* ذاكرة النظام */
        .memory-warning {
            background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
            color: white;
            padding: 12px 20px;
            border-radius: var(--border-radius);
            margin: 15px 0;
            display: none;
            align-items: center;
            gap: 10px;
            animation: fadeIn 0.5s;
        }

        .memory-warning i {
            font-size: 1.2rem;
        }

        /* تحسينات للهواتف */
        @media (max-width: 768px) {
            .dashboard-layout {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                min-height: auto;
                position: relative;
                padding: 15px;
                flex-direction: row;
                flex-wrap: wrap;
                gap: 10px;
            }
            
            .sidebar > * {
                flex: 1 1 calc(50% - 10px);
                margin-bottom: 10px;
            }
            
            .logo {
                flex-basis: 100%;
                margin-bottom: 10px;
            }
            
            .feature-tabs {
                flex-basis: 100%;
            }
            
            .main-content {
                padding: 15px;
            }
            
            .header-section {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-container {
                width: 100%;
            }
            
            .key-metrics {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .monthly-report-mobile-warning {
                display: block;
            }
            
            .monthly-report-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .monthly-report-search-box {
                max-width: 100%;
            }
            
            .monthly-report-month-selector {
                justify-content: center;
            }
            
            .monthly-report-month-btn {
                padding: 8px 12px;
                font-size: 0.9rem;
            }
            
            .monthly-report-stat-box {
                min-width: 120px;
                padding: 10px 12px;
            }
            
            .monthly-report-header h1 {
                font-size: 1.5rem;
            }
        }

        @media (max-width: 480px) {
            .key-metrics {
                grid-template-columns: 1fr;
            }
            
            .sidebar > * {
                flex-basis: 100%;
            }
            
            .monthly-report-month-selector {
                justify-content: center;
            }
            
            .monthly-report-month-btn {
                padding: 8px 10px;
                font-size: 0.85rem;
                flex: 1;
                min-width: calc(33.333% - 10px);
            }
            
            .monthly-report-stats {
                gap: 10px;
            }
            
            .monthly-report-stat-box {
                min-width: calc(50% - 10px);
            }
        }

        .save-notification {
            position: fixed;
            bottom: 220px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background-color: var(--success);
            color: white;
            padding: 15px 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            opacity: 0;
            visibility: hidden;
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
        }

        .save-notification.show {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
        }

        .save-notification.error {
            background-color: var(--danger);
        }

        /* Loading Spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background-color: var(--card-bg);
            color: var(--text-dark);
            padding: 15px 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideInRight 0.3s ease-out;
            max-width: 300px;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 99999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            transform: translateY(-50px);
            transition: transform 0.3s;
        }

        .modal-overlay.active .modal {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
        }

        /* Print Styles */
        @media print {
            .sidebar,
            .feature-tabs,
            button,
            .search-container,
            .alert-section,
            .save-notification,
            #onlineStatus,
            .sync-indicator {
                display: none !important;
            }
            
            .dashboard-layout {
                display: block;
            }
            
            .main-content {
                padding: 0;
            }
            
            .data-section {
                box-shadow: none;
                border: 1px solid #000;
            }
            
            table {
                min-width: 100%;
            }
        }
    </style>
</head>

<body>
    <div id="onlineStatus"></div>
    <div id="toastContainer" class="toast-container"></div>
    
    <!-- تحذير الذاكرة -->
    <div id="memoryWarning" class="memory-warning" style="display: none;">
        <i class="fas fa-exclamation-triangle"></i>
        <span>تحذير: استهلاك الذاكرة مرتفع. يرجى إغلاق بعض النوافذ.</span>
    </div>

    <!-- System Info Modal -->
    <div class="modal-overlay" id="systemInfoModal">
        <div class="modal">
            <div class="modal-header">
                <h3 style="color: var(--primary);"><i class="fas fa-info-circle"></i> معلومات النظام</h3>
                <button class="modal-close" onclick="closeModal('systemInfoModal')">&times;</button>
            </div>
            <div id="systemInfoContent">
                <div class="spinner"></div>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal-overlay" id="exportModal">
        <div class="modal">
            <div class="modal-header">
                <h3 style="color: var(--primary);"><i class="fas fa-file-export"></i> تصدير البيانات</h3>
                <button class="modal-close" onclick="closeModal('exportModal')">&times;</button>
            </div>
            <div id="exportOptions">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 20px 0;">
                    <button onclick="exportAsExcel()" style="background-color: #28a745;">
                        <i class="fas fa-file-excel"></i> Excel
                    </button>
                    <button onclick="exportAsJSON()" style="background-color: #6f42c1;">
                        <i class="fas fa-code"></i> JSON
                    </button>
                    <button onclick="exportAsCSV()" style="background-color: #17a2b8;">
                        <i class="fas fa-file-csv"></i> CSV
                    </button>
                    <button onclick="exportAsPDF()" style="background-color: #dc3545;">
                        <i class="fas fa-file-pdf"></i> PDF
                    </button>
                </div>
                <div id="exportStatus"></div>
            </div>
        </div>
    </div>

    <div class="dashboard-layout">
        <div class="sidebar">
            <div class="logo">
                <h2><i class="fas fa-water"></i> مشروع السوفعي</h2>
            </div>

            <div class="feature-tabs">
                <button class="tab-button active" onclick="switchFeature('dashboard')" data-feature="dashboard">
                    <i class="fas fa-tachometer-alt"></i> لوحة التحكم
                </button>
                <button class="tab-button" onclick="switchFeature('monthly-report')" data-feature="monthly-report">
                    <i class="fas fa-chart-line"></i> تقرير القرى
                </button>
            </div>

            <div class="control-group-sidebar">
                <label for="villageSelect">اختيار القرية</label>
                <select id="villageSelect">
                    <option value="السوفعي">السوفعي</option>
                    <option value="العليا">ذي عدين العليا</option>
                    <option value="السفلى">ذي عدين السفلى</option>
                    <option value="الشعابي">الشعابي</option>
                    <option value="الجبل">الجبل</option>
                    <option value="حيزان">حيزان</option>
                    <option value="رقش">ذي رقش</option>
                    <option value="الضرفه">الضرفه</option>
                </select>
            </div>

            <div class="control-group-sidebar">
                <label for="monthSelect">اختيار الشهر</label>
                <select id="monthSelect">
                    <option value="شهر 1">شهر 1</option>
                    <option value="شهر 2">شهر 2</option>
                    <option value="شهر 3">شهر 3</option>
                    <option value="شهر 4">شهر 4</option>
                    <option value="شهر 5">شهر 5</option>
                    <option value="شهر 6">شهر 6</option>
                    <option value="شهر 7">شهر 7</option>
                    <option value="شهر 8">شهر 8</option>
                    <option value="شهر 9">شهر 9</option>
                    <option value="شهر 10">شهر 10</option>
                    <option value="شهر 11">شهر 11</option>
                    <option value="شهر 12">شهر 12</option>
                </select>
            </div>

            <button onclick="dataManager.loadData(true)" id="refreshBtn">
                <i class="fas fa-sync-alt"></i> تحديث البيانات
            </button>
            
            <button onclick="AI_ANALYSIS_FUNCTION.generateReport()" id="aiAnalysisBtn" style="background-color: var(--ai-color);">
                <i class="fas fa-robot"></i> مساعد التحليل AI
            </button>

            <button id="toggleLateBalancesBtn">
                <i class="fas fa-filter"></i> إظهار المتأخرين (> 5000): الكل
            </button>

            <button onclick="syncManager.syncImmediately()" id="syncBtn" style="background-color: var(--danger);">
                <i class="fas fa-upload"></i> مزامنة معلّقة <span class="sync-badge">0</span>
            </button>

            <button onclick="autoRefreshToggle()" id="autoRefreshBtn" style="background-color: #17a2b8;">
                <i class="fas fa-sync"></i> التحديث التلقائي: غير مفعل
            </button>

            <button onclick="startPreloadData()" id="preloadBtn" style="background-color: #6f42c1;">
                <i class="fas fa-download"></i> تحميل البيانات للعمل بدون نت
            </button>
            
            <!-- زر وضع التركيز -->
            <button onclick="focusManager.toggleFocusMode()" id="focusModeBtn" style="background-color: var(--focus-color);">
                <i class="fas fa-crosshairs"></i> وضع التركيز: غير نشط
            </button>

            <div style="flex-grow: 1;"></div>
            
            <div style="margin-top: auto; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                <button onclick="toggleDarkMode()" id="darkModeBtn" style="background-color: #343a40; margin-bottom: 10px;">
                    <i class="fas fa-moon"></i> الوضع الداكن
                </button>
                
                <button onclick="toggleHighContrast()" id="contrastBtn" style="background-color: #5a6268; margin-bottom: 10px;">
                    <i class="fas fa-adjust"></i> وضع عالي التباين
                </button>
                
                <button onclick="showExportModal()" id="exportBtn" style="background-color: #fd7e14; margin-bottom: 10px;">
                    <i class="fas fa-file-export"></i> تصدير متعدد
                </button>
                
                <button onclick="exportBackup()" id="backupBtn" style="background-color: #28a745;">
                    <i class="fas fa-database"></i> نسخ احتياطي
                </button>
            </div>
            
            <button onclick="printTable()" style="background-color: #6c757d;">
                <i class="fas fa-print"></i> طباعة
            </button>
        </div>

        <div class="main-content">
            <!-- محتوى لوحة التحكم -->
            <div id="dashboard-content" class="feature-content active">
                <div class="header-section">
                    <h1 style="font-size: 2rem;">لوحة معلومات المشتركين</h1>
                    <div class="search-container">
                        <input type="text" id="searchInput" placeholder="بحث بالاسم أو رقم العداد...">
                        <i class="fas fa-search"></i>
                    </div>
                </div>

                <div class="status-indicator" id="statusIndicator">
                    <span class="status-dot"></span>
                    <span id="statusText">جاهز</span>
                </div>

                <div id="aiAnalysisSection" style="margin-bottom: 25px;">
                    <h2 class="section-title" style="color: var(--ai-color); margin-bottom: 15px;">
                        <i class="fas fa-brain"></i> تقرير التحليل الذكي للقرية
                    </h2>
                    <div id="aiAnalysisContent">
                        <div style="text-align: center; color: var(--text-light);">
                            <i class="fas fa-magic fa-4x" style="opacity: 0.2;"></i>
                            <p style="margin-top: 15px;">اضغط على زر "مساعد التحليل AI" في القائمة الجانبية لتوليد التقرير.</p>
                        </div>
                    </div>
                </div>

                <div class="key-metrics">
                    <div class="metric-card" style="border-right-color: #ff0077;">
                        <div class="metric-info">
                            <h3><i class="fas fa-fire"></i> إجمالي استهلاك الفئة العليا (م³)</h3>
                            <p id="totalHighConsumption">0.00</p>
                        </div>
                        <i class="metric-icon fas fa-bell" style="color: #ff0077;"></i>
                    </div>

                    <div class="metric-card">
                        <div class="metric-info">
                            <h3><i class="fas fa-tint"></i> إجمالي الاستهلاك (م³)</h3>
                            <p id="totalConsumption">0.00</p>
                        </div>
                        <i class="metric-icon fas fa-chart-line" style="color: var(--secondary);"></i>
                    </div>
                    <div class="metric-card paid-metric">
                        <div class="metric-info">
                            <h3><i class="fas fa-wallet"></i> إجمالي المسلّم/المدفوع</h3>
                            <p id="totalPaid">0.00</p>
                        </div>
                        <i class="metric-icon fas fa-money-check-alt"></i>
                    </div>
                    <div class="metric-card" style="border-right-color: var(--success);">
                        <div class="metric-info">
                            <h3><i class="fas fa-coins"></i> الإجمالي المطلوب</h3>
                            <p id="totalRequired">0.00</p>
                        </div>
                        <i class="metric-icon fas fa-hand-holding-usd" style="color: var(--success);"></i>
                    </div>
                    <div class="metric-card" style="border-right-color: var(--danger);">
                        <div class="metric-info">
                            <h3><i class="fas fa-exclamation-triangle"></i> إجمالي المتبقي</h3>
                            <p id="totalRemaining">0.00</p>
                        </div>
                        <i class="metric-icon fas fa-receipt" style="color: var(--danger);"></i>
                    </div>
                    <div class="metric-card" style="border-right-color: #ff8000;">
                        <div class="metric-info">
                            <h3><i class="fas fa-percent"></i> معدل التحصيل (المدفوع / المطلوب)</h3>
                            <p id="collectionRate">0.00%</p>
                        </div>
                        <i class="metric-icon fas fa-chart-pie" style="color: #ff8000;"></i>
                    </div>
                    <div class="metric-card" style="border-right-color: var(--warning);">
                        <div class="metric-info">
                            <h3><i class="fas fa-users"></i> إجمالي المشتركين</h3>
                            <p id="totalSubscribers">0</p>
                        </div>
                        <i class="metric-icon fas fa-user-check" style="color: var(--warning);"></i>
                    </div>
                </div>

                <div class="data-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px solid var(--accent); padding-bottom: 10px;">
                        <h2 class="section-title" style="margin: 0; border-bottom: none;"><i class="fas fa-chart-area"></i> ملخص الأداء الشهري</h2>

                        <button onclick="toggleAlertsDisplay()" id="toggleAlertsBtn" style="
                            background-color: var(--info);
                            color: white;
                            padding: 8px 15px;
                            border: none;
                            border-radius: var(--border-radius);
                            cursor: pointer;
                            font-family: 'Tajawal', sans-serif;
                            font-weight: 500;
                            transition: var(--transition);
                        ">
                            <i class="fas fa-eye"></i> إظهار التنبيهات
                        </button>
                    </div>
                    <div id="alertSection" class="alert-section" style="display: none;">
                    </div>

                    <div style="display: flex; flex-wrap: wrap; gap: 20px; margin-top: 20px;">
                        <div style="flex: 2; min-width: 350px; max-width: 65%; height: 300px; padding: 10px;">
                            <canvas id="consumptionChart"></canvas>
                        </div>
                        <div style="flex: 1; min-width: 200px; max-width: 30%; height: 300px; padding: 10px;">
                            <canvas id="paymentChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="data-section">
                    <h2 class="section-title"><i class="fas fa-table"></i> جدول بيانات القراءات</h2>
                    <div class="table-container">
                        <table id="dataTable">
                        </table>
                    </div>
                </div>
            </div>

            <!-- محتوى تقرير القرى الشهري -->
            <div id="monthly-report-content" class="feature-content">
                <div class="monthly-report-container">
                    <header class="monthly-report-header">
                        <h1><i class="fas fa-chart-line"></i> تقرير متابعة القرى الشهري</h1>
                        <p class="monthly-report-subtitle">عرض تفصيلي للإيرادات والمستحقات (يتم تحديث البيانات تلقائياً)</p>
                        
                        <div class="monthly-report-stats">
                            <div class="monthly-report-stat-box">
                                <div class="monthly-report-stat-value" id="total-villages">...</div>
                                <div class="monthly-report-stat-label">عدد القرى</div>
                            </div>
                            <div class="monthly-report-stat-box">
                                <div class="monthly-report-stat-value" id="total-months">...</div>
                                <div class="monthly-report-stat-label">عدد الأشهر المتاحة</div>
                            </div>
                            <div class="monthly-report-stat-box">
                                <div class="monthly-report-stat-value" id="total-remaining">...</div>
                                <div class="monthly-report-stat-label">إجمالي المتبقي</div>
                            </div>
                            <div class="monthly-report-stat-box">
                                <div class="monthly-report-stat-value" id="last-month">...</div>
                                <div class="monthly-report-stat-label">آخر شهر متاح</div>
                            </div>
                        </div>
                    </header>
                    
                    <div class="monthly-report-mobile-warning">
                        <i class="fas fa-mobile-alt"></i> يمكنك التمرير أفقيًا لعرض كامل الجدول على الهواتف المحمولة
                    </div>
                    
                    <div class="monthly-report-controls">
                        <div class="monthly-report-month-selector" id="monthSelector">
                            <div class="monthly-report-loading">جاري تحميل البيانات...</div>
                        </div>
                        
                        <div class="monthly-report-search-box">
                            <input type="text" id="monthlyReportSearchInput" placeholder="ابحث باسم القرية..." disabled>
                            <i class="fas fa-search"></i>
                        </div>
                    </div>
                    
                    <div class="monthly-report-table-container">
                        <div class="monthly-report-month-title" id="tableTitle">جاري تحميل التقرير...</div>
                        <div id="tableContent">
                            <div class="monthly-report-loading">الرجاء الانتظار بينما يتم جلب البيانات من المصدر...</div>
                        </div>
                    </div>
                    
                    <p class="monthly-report-data-source" id="dataSourceMessage">
                        <i class="fas fa-database"></i> جاري محاولة الاتصال بمصدر البيانات الخارجي...
                    </p>
                </div>
            </div>

            <footer style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee; color: var(--text-light); font-size: 0.9rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;">
                    <div>
                        <p>© 2025 مشروع مياه السوفعي. تصميم وتطوير متقدم.</p>
                        <p style="font-size: 0.8rem; margin-top: 5px;" id="performanceStats">
                            <i class="fas fa-tachometer-alt"></i> أداء النظام: <span id="loadTime">0</span>مللي ثانية | 
                            الذاكرة: <span id="memoryUsage">0</span>MB |
                            المشتركين النشطين: <span id="activeSubscribers">0</span>
                        </p>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="showSystemInfo()" style="
                            background: none;
                            border: 1px solid var(--primary);
                            color: var(--primary);
                            padding: 8px 15px;
                            border-radius: 5px;
                            cursor: pointer;
                            font-family: 'Tajawal', sans-serif;
                            font-size: 0.9rem;
                        ">
                            <i class="fas fa-info-circle"></i> معلومات النظام
                        </button>
                        <button onclick="clearCache()" style="
                            background: none;
                            border: 1px solid var(--danger);
                            color: var(--danger);
                            padding: 8px 15px;
                            border-radius: 5px;
                            cursor: pointer;
                            font-family: 'Tajawal', sans-serif;
                            font-size: 0.9rem;
                        ">
                            <i class="fas fa-trash-alt"></i> مسح الذاكرة
                        </button>
                    </div>
                </div>
            </footer>
        </div>
    </div>

    <div class="save-notification" id="saveNotification">
        <i class="fas fa-check-circle"></i>
        <span>تم حفظ البيانات بنجاح</span>
    </div>

    <script>
        // ===== الإعدادات الأساسية الأصلية =====
        const villageAPIs = {
            "السوفعي": "https://script.google.com/macros/s/AKfycbxwk4kUq6iKrILZZj97hoHw4x8oJLTcJW_imP3J7LloQBR79DDlY31AAcRRHytcJNon/exec",
            "العليا": "https://script.google.com/macros/s/AKfycbwxfCWbufmKMvNZXzmuK6PqbmUSH7px3HmIQcJl2Am8vM5FCCNZHQ_kIrTBbzdDe6-aMQ/exec",
            "السفلى": "https://script.google.com/macros/s/AKfycbwrtgwr8WYMlNcQzj3qCF6-OvAei6EFK_e2LzuMLAfc4WDVlguqdCOzdF9gTWh8mYA/exec",
            "الشعابي": "https://script.google.com/macros/s/AKfycbyAcUuicFALQFVgMjc7TSCmZ1lzCzoMFjHOZy2q-nlZv2nq0bCY77-0BpY7U2zFRWJ2AA/exec",
            "الجبل": "https://script.google.com/macros/s/AKfycbzr81y7Am5rC4VGOwwzFDpACNzIe9sE9DW9zy1SFy4HNSOrWs4gshHBlCCCXKYnPFFC/exec",
            "حيزان": "https://script.google.com/macros/s/AKfycbyZZ5AAuEineNuWWMsMYJaqTcsH7KA8l2Xov6AC_qJn4uAFhNRxRW1A1icCVYlH79bK/exec",
            "رقش": "https://script.google.com/macros/s/AKfycbxMD6WXWvALfYxuCre5On3yS1u7HqxxdjYUqVF8s1KfNgcQTqKQXQ3DxbEh0RHX08gA/exec",
            "الضرفه": "https://script.google.com/macros/s/AKfycbzgjurHK5GQX43r7aqP_365sL-2CQksnwqlkdYP03pcZLna-6it60FfpcQ0TasMAG0/exec"
        };

        // نظام التشفير للـ API Keys (نظام أساسي فقط)
        const API_ENCRYPTOR = {
            encrypt: function(key) {
                return btoa(key).split('').reverse().join('');
            },
            decrypt: function(encrypted) {
                return atob(encrypted.split('').reverse().join(''));
            }
        };

        const COLUMN_HEADERS = [
            { letter: "A", icon: "fas fa-hashtag", label: "رقم العداد", col: 0, width: "80px" },
            { letter: "B", icon: "fas fa-user", label: "الاسم", col: 1, width: "200px" },
            { letter: "C", icon: "fas fa-tachometer-alt", label: "قراءة سابقة", col: 2 },
            { letter: "D", icon: "fas fa-tachometer-alt", label: "قراءة حالية", col: 3, editable: true, validation: 'reading' },
            { letter: "E", icon: "fas fa-cube", label: "الاستهلاك (1-8م³)", col: 4 },
            { letter: "F", icon: "fas fa-cube", label: "الاستهلاك (9م³ فأكثر)", col: 5 },
            { letter: "G", icon: "fas fa-dollar-sign", label: "قيمة الاستهلاك", col: 6 },
            { letter: "H", icon: "fas fa-home", label: "رسوم ثابتة", col: 7 },
            { letter: "I", icon: "fas fa-calendar-alt", label: "متأخرات سابقة", col: 8 },
            { letter: "J", icon: "fas fa-funnel-dollar", label: "الإجمالي المطلوب", col: 9 },
            { letter: "K", icon: "fas fa-hand-holding-usd", label: "إيرادات أخرى", col: 10, editable: true, validation: 'paid' },
            { letter: "L", icon: "fas fa-money-check-alt", label: "المسلم", col: 11, editable: true, validation: 'paid' },
            { letter: "M", icon: "fas fa-receipt", label: "المتبقي", col: 12 },
            { letter: "N", icon: "fas fa-sticky-note", label: "ملاحظات", col: 13, editable: true, validation: 'text' },
        ];

        const FIXED_RATES = {
            fixedFee: 500,
            tariffF1: 200,
            tariffF2: 400,
            threshold: 8
        };

        const SYNC_CONFIG = {
            maxRetries: 3,
            retryDelay: 2000,
            batchSize: 5,
            syncOnConnect: true,
            syncInterval: 10000,
            offlineTTL: 7 * 24 * 60 * 60 * 1000
        };

        const DB_NAME = 'WaterManagementDB_V6';
        const DB_VERSION = 7;
        const STORE_NAME = 'villageData';
        const SYNC_STORE = 'syncQueue';
        const ERROR_LOG_STORE = 'errorLog';
        const USER_SETTINGS_STORE = 'userSettings';

        const SAVE_DELAY = 500;
        const LATE_BALANCE_THRESHOLD = 5000;
        const MEMORY_WARNING_THRESHOLD = 300; // 300MB
        const MAX_CELL_SAVE_TIMERS = 100;
        
        let db = null;
        let autoRefreshInterval = null;
        let isAutoRefresh = false;
        let alertsVisible = false;
        let isFocusMode = false;
        let currentFocusRow = null;

        // ===== عناصر واجهة المستخدم =====
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');
        const autoRefreshBtn = document.getElementById('autoRefreshBtn');
        const syncBtn = document.getElementById('syncBtn');
        const focusModeBtn = document.getElementById('focusModeBtn');
        const onlineStatusEl = document.getElementById('onlineStatus');
        const searchInput = document.getElementById('searchInput');
        const monthSelect = document.getElementById('monthSelect');
        const villageSelect = document.getElementById('villageSelect');
        const refreshBtn = document.getElementById('refreshBtn');
        const alertSection = document.getElementById('alertSection');
        const toggleLateBalancesBtn = document.getElementById('toggleLateBalancesBtn');
        let toggleAlertsBtn = document.getElementById('toggleAlertsBtn');
        const aiAnalysisSection = document.getElementById('aiAnalysisSection');
        const aiAnalysisContent = document.getElementById('aiAnalysisContent');
        const aiAnalysisBtn = document.getElementById('aiAnalysisBtn');
        const darkModeBtn = document.getElementById('darkModeBtn');
        const memoryWarning = document.getElementById('memoryWarning');
        const activeSubscribersEl = document.getElementById('activeSubscribers');

        // عناصر المقاييس
        const totalConsumptionEl = document.getElementById('totalConsumption');
        const totalHighConsumptionEl = document.getElementById('totalHighConsumption');
        const totalPaidEl = document.getElementById('totalPaid');
        const totalRequiredEl = document.getElementById('totalRequired');
        const totalRemainingEl = document.getElementById('totalRemaining');
        const totalSubscribersEl = document.getElementById('totalSubscribers');
        const collectionRateEl = document.getElementById('collectionRate');
        const tableBody = document.getElementById('dataTable');

        // الرسوم البيانية
        let consumptionChartInstance = null;
        let paymentChartInstance = null;
        const cellSaveTimers = new Map();

        // ===== نظام إدارة الذاكرة المحسن =====
        class MemoryMonitor {
            constructor() {
                this.checkInterval = null;
                this.memoryWarningShown = false;
                this.chartsPaused = false;
                this.cleanupInterval = null;
                this.lastCleanupTime = 0;
                this.cleanupCooldown = 60000; // 1 دقيقة بين عمليات التنظيف
            }

            startMonitoring() {
                // تنظيف أي مراقبة سابقة
                this.stopMonitoring();
                
                // تحقق من الذاكرة كل 30 ثانية
                this.checkInterval = setInterval(() => {
                    this.checkMemoryUsage();
                    this.cleanupOldTimers();
                }, 30000);
                
                // تنظيف دوري كل دقيقة
                this.cleanupInterval = setInterval(() => {
                    this.forceCleanup();
                }, 60000);

                // تحقق فوراً عند البدء
                setTimeout(() => this.checkMemoryUsage(), 5000);
            }

            checkMemoryUsage() {
                if (!performance.memory) return;

                const usedMB = Math.round(performance.memory.usedJSHeapSize / (1024 * 1024));
                const totalMB = Math.round(performance.memory.jsHeapSizeLimit / (1024 * 1024));
                const usagePercentage = (usedMB / totalMB) * 100;

                // تحديث عرض الذاكرة
                if (document.getElementById('memoryUsage')) {
                    document.getElementById('memoryUsage').textContent = usedMB;
                }

                // تحذير إذا تجاوز الحد
                if (usedMB > MEMORY_WARNING_THRESHOLD && !this.memoryWarningShown) {
                    this.showMemoryWarning(usedMB, usagePercentage);
                    this.memoryWarningShown = true;
                    
                    // محاولة تقليل استخدام الذاكرة
                    this.freeUpMemory();
                } else if (usedMB <= MEMORY_WARNING_THRESHOLD * 0.8) {
                    this.memoryWarningShown = false;
                    this.hideMemoryWarning();
                }

                // إيقاف الرسوم البيانية مؤقتاً إذا كانت الذاكرة مرتفعة
                if (usagePercentage > 85 && !this.chartsPaused) {
                    this.pauseCharts();
                } else if (usagePercentage < 70 && this.chartsPaused) {
                    this.resumeCharts();
                }
            }

            showMemoryWarning(usedMB, percentage) {
                memoryWarning.innerHTML = `
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>تحذير: استهلاك الذاكرة ${usedMB}MB (${Math.round(percentage)}%)</span>
                    <button onclick="memoryMonitor.freeUpMemory()" style="
                        margin-right: 10px;
                        background: white;
                        color: #ff6b6b;
                        border: none;
                        padding: 5px 10px;
                        border-radius: 4px;
                        cursor: pointer;
                        font-weight: bold;
                    ">
                        تحسين الذاكرة
                    </button>
                `;
                memoryWarning.style.display = 'flex';
            }

            hideMemoryWarning() {
                memoryWarning.style.display = 'none';
            }

            freeUpMemory() {
                console.log('🔧 تحرير الذاكرة...');
                this.forceCleanup();
                
                // تخفيف الحمل على المتصفح
                setTimeout(() => {
                    this.collectGarbage();
                }, 100);
                
                showToast('تم تحسين استخدام الذاكرة', 'success');
                this.hideMemoryWarning();
                this.memoryWarningShown = false;
            }

            forceCleanup() {
                const now = Date.now();
                if (now - this.lastCleanupTime < this.cleanupCooldown) {
                    return;
                }
                
                this.lastCleanupTime = now;
                
                // 1. تنظيف مؤقتات الخلايا القديمة
                this.cleanupOldTimers();
                
                // 2. إلغاء أي وقت تأخير للبحث
                if (searchInput.timer) {
                    clearTimeout(searchInput.timer);
                    searchInput.timer = null;
                }
                
                // 3. تحرير مراجع DOM
                this.cleanupDOMReferences();
                
                // 4. إعادة إنشاء الرسوم البيانية إذا كانت كبيرة
                this.optimizeCharts();
                
                console.log('✅ تم تنظيف الذاكرة');
            }

            cleanupOldTimers() {
                // تنظيف مؤقتات الخلايا القديمة
                const now = Date.now();
                let cleaned = 0;
                
                for (const [key, timer] of cellSaveTimers.entries()) {
                    // إذا مر أكثر من 1 دقيقة على المؤقت
                    if (now - timer.createdAt > 60000) {
                        clearTimeout(timer.timerId);
                        cellSaveTimers.delete(key);
                        cleaned++;
                    }
                }
                
                // حذف المؤقتات الزائدة
                if (cellSaveTimers.size > MAX_CELL_SAVE_TIMERS) {
                    const excess = Array.from(cellSaveTimers.keys()).slice(0, cellSaveTimers.size - MAX_CELL_SAVE_TIMERS);
                    excess.forEach(key => {
                        clearTimeout(cellSaveTimers.get(key).timerId);
                        cellSaveTimers.delete(key);
                        cleaned++;
                    });
                }
                
                if (cleaned > 0) {
                    console.log(`🗑️ تم تنظيف ${cleaned} مؤقت قديم`);
                }
            }

            cleanupDOMReferences() {
                // إزالة مستمعي الأحداث الزائدين
                const cleanupEventListeners = () => {
                    // نستخدم WeakMap لتتبع المستمعين
                    if (!window.eventListenerMap) {
                        window.eventListenerMap = new WeakMap();
                    }
                };
                
                cleanupEventListeners();
                
                // إزالة المراجع المؤقتة
                if (window.tempData) {
                    delete window.tempData;
                }
                
                // تحرير الذاكرة المؤقتة
                if (window.performance && window.performance.clearResourceTimings) {
                    window.performance.clearResourceTimings();
                }
            }

            optimizeCharts() {
                // إعادة إنشاء الرسوم البيانية إذا كانت كبيرة جداً
                if (consumptionChartInstance && consumptionChartInstance.data.datasets[0].data.length > 100) {
                    consumptionChartInstance.destroy();
                    consumptionChartInstance = null;
                }
                
                if (paymentChartInstance && paymentChartInstance.data.datasets[0].data.length > 50) {
                    paymentChartInstance.destroy();
                    paymentChartInstance = null;
                }
            }

            pauseCharts() {
                if (consumptionChartInstance) {
                    consumptionChartInstance.options.animation = false;
                    consumptionChartInstance.update('none');
                }
                if (paymentChartInstance) {
                    paymentChartInstance.options.animation = false;
                    paymentChartInstance.update('none');
                }
                this.chartsPaused = true;
            }

            resumeCharts() {
                if (consumptionChartInstance) {
                    consumptionChartInstance.options.animation = { duration: 1000 };
                    consumptionChartInstance.update();
                }
                if (paymentChartInstance) {
                    paymentChartInstance.options.animation = { duration: 1000 };
                    paymentChartInstance.update();
                }
                this.chartsPaused = false;
            }

            collectGarbage() {
                // محاولة إجبار جمع القمامة
                try {
                    if (window.gc) {
                        window.gc();
                    } else if (window.GCController) {
                        window.GCController.collect();
                    }
                } catch (e) {
                    // محاولات بديلة
                    try {
                        const arr = [];
                        for (let i = 0; i < 1000000; i++) {
                            arr.push(new Array(1000));
                        }
                        arr.length = 0;
                    } catch (e2) {}
                }
            }

            stopMonitoring() {
                if (this.checkInterval) {
                    clearInterval(this.checkInterval);
                    this.checkInterval = null;
                }
                
                if (this.cleanupInterval) {
                    clearInterval(this.cleanupInterval);
                    this.cleanupInterval = null;
                }
                
                // تنظيف جميع المؤقتات
                this.cleanupAllTimers();
            }

            cleanupAllTimers() {
                // تنظيف جميع مؤقتات الخلايا
                for (const [key, timer] of cellSaveTimers.entries()) {
                    clearTimeout(timer.timerId);
                    cellSaveTimers.delete(key);
                }
                
                // تنظيف مؤقت البحث
                if (searchInput && searchInput.timer) {
                    clearTimeout(searchInput.timer);
                    searchInput.timer = null;
                }
                
                // تنظيف مؤقت التحديث التلقائي
                if (dataManager && dataManager.refreshTimer) {
                    clearInterval(dataManager.refreshTimer);
                    dataManager.refreshTimer = null;
                }
            }
        }

        const memoryMonitor = new MemoryMonitor();

        // ===== نظام وضع التركيز =====
        class FocusManager {
            constructor() {
                this.isActive = false;
                this.currentRow = null;
                this.scrollPosition = 0;
                this.rowClickHandler = this.handleRowClick.bind(this);
            }

            toggleFocusMode() {
                this.isActive = !this.isActive;
                
                if (this.isActive) {
                    this.activateFocusMode();
                } else {
                    this.deactivateFocusMode();
                }
                
                this.updateUI();
            }

            activateFocusMode() {
                // حفظ موضع التمرير الحالي
                this.scrollPosition = document.querySelector('.table-container')?.scrollTop || 0;
                
                // إضافة مستمع للنقر على الصفوف
                const table = document.getElementById('dataTable');
                if (table) {
                    table.addEventListener('click', this.rowClickHandler);
                }
                
                // تغيير مؤشر الفأرة
                document.querySelectorAll('#dataTable tr:not(:first-child):not(:last-child)').forEach(tr => {
                    tr.style.cursor = 'pointer';
                    tr.title = 'انقر للتركيز على هذا المشترك';
                });
                
                showToast('وضع التركيز مفعل. انقر على أي صف للتركيز عليه', 'info');
            }

            deactivateFocusMode() {
                // إزالة التركيز الحالي
                if (this.currentRow) {
                    this.currentRow.classList.remove('focus-row');
                    this.currentRow = null;
                }
                
                // إزالة مستمع النقر
                const table = document.getElementById('dataTable');
                if (table) {
                    table.removeEventListener('click', this.rowClickHandler);
                }
                
                // إعادة مؤشر الفأرة الطبيعي
                document.querySelectorAll('#dataTable tr').forEach(tr => {
                    tr.style.cursor = '';
                    tr.title = '';
                });
                
                // العودة لموضع التمرير السابق
                if (this.scrollPosition) {
                    const container = document.querySelector('.table-container');
                    if (container) {
                        container.scrollTop = this.scrollPosition;
                    }
                }
            }

            handleRowClick(event) {
                const row = event.target.closest('tr');
                if (!row || row.classList.contains('total-row') || row.cells.length < 2) return;

                // إزالة التركيز من الصف السابق
                if (this.currentRow && this.currentRow !== row) {
                    this.currentRow.classList.remove('focus-row');
                }

                // تطبيق التركيز على الصف الجديد
                this.currentRow = row;
                row.classList.add('focus-row');
                
                // تمرير الصف إلى منتصف الشاشة
                this.scrollToRow(row);
                
                // عرض معلومات المشترك
                this.showSubscriberInfo(row);
            }

            scrollToRow(row) {
                const container = document.querySelector('.table-container');
                if (!container) return;
                
                const rowTop = row.offsetTop;
                const rowHeight = row.offsetHeight;
                const containerHeight = container.clientHeight;
                
                container.scrollTop = rowTop - (containerHeight / 2) + (rowHeight / 2);
            }

            showSubscriberInfo(row) {
                const cells = row.cells;
                if (cells.length < 13) return;
                
                const subscriberInfo = {
                    name: cells[1].textContent,
                    meterId: cells[0].textContent,
                    consumption: cells[4].textContent + ' + ' + cells[5].textContent + ' م³',
                    required: cells[9].textContent,
                    paid: cells[11].textContent,
                    remaining: cells[12].textContent
                };

                // تحديث شريط الحالة
                updateStatus(`التركيز على: ${subscriberInfo.name} (${subscriberInfo.meterId}) | المتبقي: ${subscriberInfo.remaining}`);
                
                // تحديث عدد المشتركين النشطين
                this.updateActiveSubscribers();
            }

            updateActiveSubscribers() {
                const activeRows = document.querySelectorAll('#dataTable .focus-row').length;
                if (activeSubscribersEl) {
                    activeSubscribersEl.textContent = activeRows;
                }
            }

            updateUI() {
                if (this.isActive) {
                    focusModeBtn.innerHTML = '<i class="fas fa-crosshairs"></i> وضع التركيز: نشط';
                    focusModeBtn.style.backgroundColor = 'var(--focus-color)';
                } else {
                    focusModeBtn.innerHTML = '<i class="fas fa-crosshairs"></i> وضع التركيز: غير نشط';
                    focusModeBtn.style.backgroundColor = 'var(--focus-color)';
                    focusModeBtn.style.opacity = '0.8';
                }
            }
            
            cleanup() {
                this.deactivateFocusMode();
                this.currentRow = null;
                this.scrollPosition = 0;
            }
        }

        const focusManager = new FocusManager();

        // نظام تسجيل الأخطاء
        const ErrorLogger = {
            log: async (error, context = {}) => {
                const errorEntry = {
                    timestamp: new Date().toISOString(),
                    error: error.message,
                    stack: error.stack,
                    context,
                    userAgent: navigator.userAgent,
                    online: navigator.onLine,
                    url: window.location.href
                };

                console.error('📋 Error logged:', errorEntry);

                // حفظ في قاعدة البيانات
                if (db) {
                    try {
                        const transaction = db.transaction([ERROR_LOG_STORE], 'readwrite');
                        const store = transaction.objectStore(ERROR_LOG_STORE);
                        store.put({ ...errorEntry, id: Date.now() });
                    } catch (dbError) {
                        console.error('Failed to save error to DB:', dbError);
                    }
                }

                return errorEntry;
            },

            getRecentErrors: async (limit = 50) => {
                if (!db) return [];
                
                return new Promise((resolve) => {
                    const transaction = db.transaction([ERROR_LOG_STORE], 'readonly');
                    const store = transaction.objectStore(ERROR_LOG_STORE);
                    const request = store.getAll();
                    
                    request.onsuccess = () => {
                        const errors = request.result || [];
                        errors.sort((a, b) => b.timestamp - a.timestamp);
                        resolve(errors.slice(0, limit));
                    };
                    
                    request.onerror = () => resolve([]);
                });
            },

            clearOldErrors: async (days = 30) => {
                if (!db) return;
                
                const cutoffDate = Date.now() - (days * 24 * 60 * 60 * 1000);
                
                return new Promise((resolve) => {
                    const transaction = db.transaction([ERROR_LOG_STORE], 'readwrite');
                    const store = transaction.objectStore(ERROR_LOG_STORE);
                    const request = store.openCursor();
                    
                    request.onsuccess = (event) => {
                        const cursor = event.target.result;
                        if (cursor) {
                            if (new Date(cursor.value.timestamp).getTime() < cutoffDate) {
                                cursor.delete();
                            }
                            cursor.continue();
                        } else {
                            resolve();
                        }
                    };
                    
                    request.onerror = () => resolve();
                });
            }
        };

        // ===== نظام إدارة البيانات المحسن =====
        class DataManager {
            constructor() {
                this.currentData = [];
                this.filteredData = [];
                this.API_URL = "";
                this.metrics = {};
                this.showLateBalancesOnly = false;
                this.refreshTimer = null;
                this.errorCount = 0;
                this.searchIndex = new Map(); // فهرس سريع للبحث
                this.abortController = null; // للتحكم في طلبات الشبكة
            }

            get activeData() {
                return this.currentData.slice(2, this.currentData.length - 1);
            }

            get totalRowIndex() {
                return this.currentData.length > 0 ? this.currentData.length - 1 : -1;
            }

            async loadData(forceRefresh = false) {
                // إلغاء أي طلب سابق
                if (this.abortController) {
                    this.abortController.abort();
                }
                this.abortController = new AbortController();
                
                const village = villageSelect.value;
                const month = monthSelect.value;
                this.API_URL = villageAPIs[village];
                refreshBtn.disabled = true;

                updateStatus('جاري تحميل البيانات...', true);

                try {
                    let rawData = null;
                    let dataSource = 'محلي';

                    // محاولة جلب البيانات المحلية أولاً
                    rawData = await getLocalData(village, month);

                    // إذا لم تكن هناك بيانات محلية أو طلب تحديث قسري وكان الاتصال متاح
                    if ((!rawData || forceRefresh) && navigator.onLine) {
                        dataSource = 'سيرفر';
                        console.log(`جلب البيانات من السيرفر: ${this.API_URL}?sheet=${month}`);
                        
                        const timestamp = new Date().getTime();
                        const timeoutId = setTimeout(() => {
                            if (this.abortController) {
                                this.abortController.abort();
                            }
                        }, 30000);
                        
                        try {
                            const res = await fetch(`${this.API_URL}?sheet=${encodeURIComponent(month)}&t=${timestamp}`, {
                                signal: this.abortController.signal
                            });
                            clearTimeout(timeoutId);
                            
                            if (!res.ok) {
                                throw new Error(`خطأ في السيرفر: ${res.status}`);
                            }
                            
                            rawData = await res.json();

                            if (rawData && rawData.error) {
                                throw new Error(rawData.error);
                            }

                            if (!rawData || !Array.isArray(rawData)) {
                                throw new Error("بيانات غير صالحة من السيرفر");
                            }

                            // حفظ البيانات محلياً
                            await saveDataLocally(village, month, rawData);
                            
                        } catch (fetchError) {
                            clearTimeout(timeoutId);
                            console.error("خطأ في جلب البيانات من السيرفر:", fetchError);
                            ErrorLogger.log(fetchError, { village, month, action: 'fetch' });
                            
                            if (!rawData) {
                                throw new Error("لا يمكن الاتصال بالسيرفر");
                            }
                        }
                    } else if (!rawData) {
                        throw new Error("لا توجد بيانات متاحة محلياً ولا يوجد اتصال بالإنترنت");
                    }

                    // معالجة البيانات
                    this.currentData = rawData.map((row, index) => {
                        if (index > 1 && index < rawData.length - 1) {
                            return calculateDerivedData(row);
                        }
                        return row;
                    });

                    // بناء فهرس البحث
                    this.buildSearchIndex();

                    // تحديث الواجهة
                    this.metrics = this.updateKeyMetrics(this.currentData);
                    this.applyFiltersAndSearch();
                    updateAlerts(this.activeData);
                    initCharts(this.metrics, this.activeData);
                    updateStatus(`تم تحميل ${this.activeData.length} مشترك (${dataSource})`);

                    // تسجيل نجاح التحميل
                    this.errorCount = 0;

                    // تحديث عدد المشتركين النشطين
                    if (activeSubscribersEl) {
                        activeSubscribersEl.textContent = this.activeData.length;
                    }

                } catch (error) {
                    console.error("خطأ في تحميل البيانات:", error);
                    ErrorLogger.log(error, { village, month, action: 'loadData' });
                    
                    this.errorCount++;
                    renderErrorTable(`خطأ في تحميل البيانات: ${error.message}`);
                    updateStatus('خطأ في تحميل البيانات', false, true);
                    
                    // عرض رسالة خطأ للمستخدم
                    if (this.errorCount >= 3) {
                        showToast('فشل متكرر في تحميل البيانات. يرجى التحقق من الاتصال بالإنترنت.', 'error');
                    }
                } finally {
                    refreshBtn.disabled = false;
                    syncManager.updateSyncUI();
                    
                    // تنظيف المراجع
                    this.cleanup();
                    
                    // تحديث إحصائيات الأداء
                    updatePerformanceStats();
                    
                    // بدء مراقبة الذاكرة
                    memoryMonitor.startMonitoring();
                }
            }

            buildSearchIndex() {
                this.searchIndex.clear();
                const activeData = this.activeData;
                
                activeData.forEach((row, index) => {
                    const name = (row[1] || '').toString().toLowerCase().trim();
                    const meterId = (row[0] || '').toString().toLowerCase().trim();
                    
                    if (name) {
                        // إضافة كل كلمة في الاسم للفهرس
                        name.split(' ').forEach(word => {
                            if (word.length > 1) {
                                if (!this.searchIndex.has(word)) {
                                    this.searchIndex.set(word, []);
                                }
                                this.searchIndex.get(word).push(index);
                            }
                        });
                    }
                    
                    if (meterId) {
                        if (!this.searchIndex.has(meterId)) {
                            this.searchIndex.set(meterId, []);
                        }
                        this.searchIndex.get(meterId).push(index);
                    }
                });
                
                console.log(`🔍 فهرس البحث يحتوي على ${this.searchIndex.size} مفتاح`);
            }

            toggleLateBalances() {
                this.showLateBalancesOnly = !this.showLateBalancesOnly;

                toggleLateBalancesBtn.classList.toggle('active', this.showLateBalancesOnly);
                toggleLateBalancesBtn.innerHTML = `<i class="fas fa-filter"></i> إظهار المتأخرين (> 5000): ${this.showLateBalancesOnly ? 'المتأخرون فقط' : 'الكل'}`;

                this.applyFiltersAndSearch();
            }

            applyFiltersAndSearch() {
                const searchTerm = searchInput.value.trim().toLowerCase();

                let activeRows = this.currentData.slice(2, this.totalRowIndex);
                
                if (this.showLateBalancesOnly) {
                    activeRows = activeRows.filter(row => {
                        const remaining = parseFloat(row[12]) || 0;
                        return remaining > LATE_BALANCE_THRESHOLD;
                    });
                }

                if (searchTerm !== '') {
                    if (this.searchIndex.size > 0 && searchTerm.length > 1) {
                        // استخدام الفهرس السريع للبحث
                        const searchWords = searchTerm.split(' ').filter(w => w.length > 1);
                        let resultIndices = new Set();
                        
                        searchWords.forEach(word => {
                            if (this.searchIndex.has(word)) {
                                this.searchIndex.get(word).forEach(idx => {
                                    resultIndices.add(idx);
                                });
                            }
                        });
                        
                        if (resultIndices.size > 0) {
                            activeRows = Array.from(resultIndices).map(idx => activeRows[idx]);
                        } else {
                            activeRows = []; // لا توجد نتائج
                        }
                    } else {
                        // البحث العادي (للنصوص القصيرة أو عندما لا يوجد فهرس)
                        activeRows = activeRows.filter(row => {
                            const meterId = row[0]?.toString().toLowerCase() || '';
                            const name = row[1]?.toString().toLowerCase() || '';

                            return name.includes(searchTerm) || meterId.includes(searchTerm);
                        });
                    }
                }

                if (this.currentData.length > 0) {
                    this.filteredData = [this.currentData[0], this.currentData[1], ...activeRows, this.currentData[this.totalRowIndex]];
                } else {
                    this.filteredData = [];
                }

                renderTable(this.filteredData);
                const actualDataRows = this.filteredData.length > 2 ? this.filteredData.length - 3 : 0;
                updateStatus(`عرض ${actualDataRows} مشترك من ${this.currentData.length - 3}`);
            }

            updateKeyMetrics(data) {
                if (!data || data.length < 3) {
                    totalConsumptionEl.textContent = formatNumber(0);
                    totalHighConsumptionEl.textContent = formatNumber(0);
                    totalRequiredEl.textContent = formatNumber(0, true);
                    totalRemainingEl.textContent = formatNumber(0, true);
                    totalSubscribersEl.textContent = formatNumber(0);
                    totalPaidEl.textContent = formatNumber(0, true);
                    collectionRateEl.textContent = "0.00%";
                    return {};
                }

                const activeData = data.slice(2, data.length - 1);

                const totalConsF1 = activeData.reduce((sum, row) => sum + (parseFloat(row[4]) || 0), 0);
                const totalConsF2 = activeData.reduce((sum, row) => sum + (parseFloat(row[5]) || 0), 0);
                const totalConsumption = totalConsF1 + totalConsF2;

                const totalRequired = activeData.reduce((sum, row) => sum + (parseFloat(row[9]) || 0), 0);
                const totalPaid = activeData.reduce((sum, row) => sum + (parseFloat(row[11]) || 0), 0);
                const totalRemaining = activeData.reduce((sum, row) => sum + (parseFloat(row[12]) || 0), 0);
                const totalSubscribers = activeData.length;

                const collectionRate = totalRequired > 0 ? (totalPaid / totalRequired) * 100 : 0;

                totalConsumptionEl.textContent = formatNumber(totalConsumption);
                totalHighConsumptionEl.textContent = formatNumber(totalConsF2);
                totalRequiredEl.textContent = formatNumber(totalRequired);
                totalRemainingEl.textContent = formatNumber(totalRemaining);
                totalSubscribersEl.textContent = formatNumber(totalSubscribers, false, 0);
                totalPaidEl.textContent = formatNumber(totalPaid);
                collectionRateEl.textContent = `${formatNumber(collectionRate)}%`;

                if (data.length > 2) {
                    const totalRow = data[data.length - 1];
                    totalRow[4] = totalConsF1.toFixed(2);
                    totalRow[5] = totalConsF2.toFixed(2);
                    totalRow[9] = totalRequired.toFixed(2);
                    totalRow[11] = totalPaid.toFixed(2);
                    totalRow[12] = totalRemaining.toFixed(2);

                    this.updateFooterRow(totalRow);
                }

                return { totalConsumption, totalRequired, totalRemaining, totalSubscribers, totalPaid, totalHighConsumption: totalConsF2, collectionRate, totalConsF1, totalConsF2 };
            }

            updateRowCells(originalIndex, newRow) {
                const globalRowIndex = dataManager.filteredData.findIndex(row => row === dataManager.currentData[originalIndex]);

                if (globalRowIndex === -1) {
                    if (!this.showLateBalancesOnly || (parseFloat(newRow[12]) || 0) > LATE_BALANCE_THRESHOLD) {
                        this.applyFiltersAndSearch();
                    }
                    return;
                }

                const tr = tableBody.rows[globalRowIndex + 1];
                if (!tr) return;

                const consumptionF2 = parseFloat(newRow[5]) || 0;

                tr.classList.remove('active-row');
                tr.style.backgroundColor = (consumptionF2 > 0) ? 'rgba(0, 180, 216, 0.1)' : '';
                tr.style.borderRight = (consumptionF2 > 0) ? '4px solid var(--secondary)' : '';

                for (let c = 0; c < COLUMN_HEADERS.length; c++) {
                    const td = tr.cells[c];
                    let cellValue = newRow[c] !== undefined ? newRow[c] : "";

                    if (c === 0 || (c >= 2 && c <= 12)) {
                        td.textContent = formatNumber(cellValue, false, c);
                    } else {
                        td.textContent = cellValue;
                    }

                    if (c === 1) {
                        td.classList.add("name-cell");
                    }

                    if (c === 5 && consumptionF2 > 0) {
                        td.style.backgroundColor = 'var(--secondary)';
                        td.style.color = 'white';
                        td.style.fontWeight = 'bold';
                    } else if (c === 5) {
                        td.style.backgroundColor = '';
                        td.style.color = '';
                        td.style.fontWeight = '';
                    }

                    if (c === 12 && !isNaN(newRow[c]) && parseFloat(newRow[c]) >= LATE_BALANCE_THRESHOLD) {
                        td.style.backgroundColor = 'var(--danger)';
                        td.style.color = 'white';
                        td.style.fontWeight = 'bold';
                    } else if (c === 12) {
                        td.style.backgroundColor = '';
                        td.style.color = '';
                        td.style.fontWeight = '';
                    }
                }

                this.metrics = this.updateKeyMetrics(this.currentData);
                initCharts(this.metrics, this.activeData);
                updateAlerts(this.activeData);
            }

            updateFooterRow(totalRow) {
                const totalRowIndex = dataManager.filteredData.findIndex(row => row === totalRow);
                if (totalRowIndex === -1) return;

                const tr = tableBody.rows[totalRowIndex + 1];
                if (!tr) return;

                const colsToUpdate = [4, 5, 9, 11, 12];
                colsToUpdate.forEach(c => {
                    const td = tr.cells[c];
                    td.textContent = formatNumber(totalRow[c], false, c);
                });
            }

            startAutoRefresh() {
                const refreshInterval = 30000;

                this.stopAutoRefresh();

                console.log('✅ Auto-refresh started. Polling Sheets every 30 seconds.');

                this.refreshTimer = setInterval(() => {
                    if (navigator.onLine) {
                        this.loadData(true);
                        console.log('Auto-refresh triggered.');
                    }
                }, refreshInterval);
            }

            stopAutoRefresh() {
                if (this.refreshTimer) {
                    clearInterval(this.refreshTimer);
                    this.refreshTimer = null;
                    console.log('⛔ Auto-refresh stopped.');
                }
            }
            
            cleanup() {
                // تنظيف المراجع المؤقتة
                if (this.abortController) {
                    this.abortController.abort();
                    this.abortController = null;
                }
                
                // تنظيف الفهرس عند تغيير القرية
                if (this.searchIndex.size > 1000) {
                    this.searchIndex.clear();
                }
            }
        }

        const dataManager = new DataManager();

        class SyncManager {
            constructor() {
                this.isSyncing = false;
                this.pendingTasks = new Map();
                this.abortController = null;
            }

            async addSyncTask(task) {
                const taskId = Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                const taskWithMeta = {
                    ...task,
                    id: taskId,
                    retryCount: 0,
                    status: 'pending',
                    createdAt: new Date().toISOString()
                };

                await this.saveTaskToDB(taskWithMeta);
                this.updateSyncUI();

                if (navigator.onLine) {
                    setTimeout(() => this.syncImmediately(), 100);
                }

                return taskId;
            }

            async syncImmediately() {
                if (this.isSyncing || !navigator.onLine) {
                    console.log('المزامنة غير ممكنة الآن:', { isSyncing: this.isSyncing, online: navigator.onLine });
                    return;
                }

                this.isSyncing = true;
                this.showSyncIndicator();

                // إلغاء أي مزامنة سابقة
                if (this.abortController) {
                    this.abortController.abort();
                }
                this.abortController = new AbortController();

                try {
                    const tasks = await this.getPendingTasksFromDB();
                    console.log('المهام المعلقة:', tasks.length);
                    
                    if (tasks.length === 0) {
                        console.log('لا توجد مهام للمزامنة');
                        return;
                    }

                    const batches = this.chunkArray(tasks, SYNC_CONFIG.batchSize);
                    let totalSuccess = 0;
                    let totalFailed = 0;

                    for (const batch of batches) {
                        const results = await this.processBatch(batch);
                        totalSuccess += results.success;
                        totalFailed += results.failed;
                        if (!navigator.onLine) break;
                    }

                    if (totalSuccess > 0) {
                        showSaveNotification(true, `تمت مزامنة ${totalSuccess} تغييراً بنجاح. جاري تحديث الحسابات.`);
                        
                        setTimeout(() => dataManager.loadData(true), 1500);
                    } else if (totalFailed > 0) {
                        showSaveNotification(false, 'فشل في مزامنة بعض التغييرات. يرجى المحاولة لاحقاً.');
                    }
                } catch (error) {
                    console.error('خطأ في المزامنة:', error);
                    ErrorLogger.log(error, { action: 'sync' });
                    showSaveNotification(false, `خطأ في المزامنة: ${error.message}`);
                } finally {
                    this.isSyncing = false;
                    this.updateSyncUI();
                    this.hideSyncIndicator();
                    
                    // تنظيف المراجع
                    if (this.abortController) {
                        this.abortController = null;
                    }
                }
            }

            async processBatch(batch) {
                const results = { success: 0, failed: 0 };

                for (const task of batch) {
                    try {
                        const apiUrl = villageAPIs[task.village];
                        const colDef = COLUMN_HEADERS.find(h => h.letter === task.col);
                        const colIndex = colDef ? colDef.col : -1;

                        console.log('مزامنة المهمة:', task);

                        // إضافة timestamp لمنع التخزين المؤقت
                        const timestamp = new Date().getTime();
                        
                        // إرسال البيانات بشكل صحيح إلى Google Apps Script
                        const formData = new FormData();
                        formData.append('sheet', task.sheet);
                        formData.append('row', task.row.toString());
                        formData.append('col', task.col);
                        formData.append('value', task.value);
                        formData.append('timestamp', timestamp.toString());

                        const res = await fetch(`${apiUrl}?t=${timestamp}`, {
                            method: "POST",
                            body: formData,
                            mode: 'no-cors', // مهم جداً لـ Google Apps Script
                            signal: this.abortController?.signal
                        });

                        console.log('استجابة السيرفر:', res);

                        // مع no-cors لا يمكن قراءة response، نفترض النجاح
                        await this.markTaskComplete(task.id);
                        this.highlightSyncedCell(task.row - 1, colIndex);
                        results.success++;
                        
                        console.log('تمت المزامنة بنجاح للمهمة:', task.id);

                    } catch (error) {
                        console.warn(`فشل مهمة ${task.id}:`, error);
                        ErrorLogger.log(error, { task, action: 'processBatch' });
                        
                        task.retryCount++;

                        if (task.retryCount >= SYNC_CONFIG.maxRetries) {
                            await this.markTaskFailed(task.id, error.message);
                            results.failed++;
                        } else {
                            task.status = 'pending';
                            await this.updateTaskInDB(task);
                        }
                    }
                }

                return results;
            }

            highlightSyncedCell(originalIndex, colIndex) {
                const globalRowIndex = dataManager.filteredData.findIndex(row => row === dataManager.currentData[originalIndex]);
                if (globalRowIndex === -1) return;

                const table = document.getElementById('dataTable');
                const row = table.rows[globalRowIndex + 1];

                if (row) {
                    const cell = row.cells[colIndex];
                    if (cell) {
                        cell.classList.remove('pending-cell');
                        cell.title = "";
                        cell.classList.add('synced-cell');
                        setTimeout(() => cell.classList.remove('synced-cell'), 1000);
                    }
                }
            }

            showSyncIndicator() {
                let indicator = document.getElementById('syncIndicator');
                if (!indicator) {
                    indicator = document.createElement('div');
                    indicator.id = 'syncIndicator';
                    indicator.className = 'sync-indicator';
                    indicator.innerHTML = `
                        <i class="fas fa-sync-alt fa-spin"></i>
                        <span>جاري مزامنة التغييرات...</span>
                    `;
                    document.body.appendChild(indicator);
                }
            }

            hideSyncIndicator() {
                const indicator = document.getElementById('syncIndicator');
                if (indicator) {
                    indicator.style.animation = 'slideOut 0.3s ease-out';
                    setTimeout(() => indicator.remove(), 300);
                }
            }

            async updateSyncUI() {
                const tasks = await this.getPendingTasksFromDB();
                const count = tasks.length;

                const badge = syncBtn.querySelector('.sync-badge');
                if (badge) {
                    badge.textContent = count;
                }

                syncBtn.innerHTML = `<i class="fas fa-upload ${count > 0 ? 'fa-shake' : ''}"></i>
                                    مزامنة معلّقة <span class="sync-badge">${count}</span>`;
                syncBtn.style.backgroundColor = count > 0 ? 'var(--danger)' : '#6c757d';
                syncBtn.disabled = count === 0;
            }

            async saveTaskToDB(task) {
                if (!db) return;
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([SYNC_STORE], 'readwrite');
                    const store = transaction.objectStore(SYNC_STORE);
                    store.put(task);
                    transaction.oncomplete = () => resolve();
                    transaction.onerror = (e) => {
                        ErrorLogger.log(e.target.error, { task, action: 'saveTaskToDB' });
                        reject(e.target.error);
                    };
                });
            }

            async getPendingTasksFromDB() {
                if (!db) return [];

                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([SYNC_STORE], 'readonly');
                    const store = transaction.objectStore(SYNC_STORE);
                    const index = store.index('status');
                    const request = index.getAll('pending');

                    request.onsuccess = () => resolve(request.result || []);
                    request.onerror = (e) => {
                        ErrorLogger.log(e.target.error, { action: 'getPendingTasksFromDB' });
                        reject(e.target.error);
                    };
                });
            }

            async markTaskComplete(taskId) {
                if (!db) return;

                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([SYNC_STORE], 'readwrite');
                    const store = transaction.objectStore(SYNC_STORE);
                    store.delete(taskId);

                    transaction.oncomplete = () => resolve();
                    transaction.onerror = (e) => {
                        ErrorLogger.log(e.target.error, { taskId, action: 'markTaskComplete' });
                        reject(e.target.error);
                    };
                });
            }

            async markTaskFailed(taskId, error) {
                if (!db) return;

                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([SYNC_STORE], 'readwrite');
                    const store = transaction.objectStore(SYNC_STORE);

                    const request = store.get(taskId);
                    request.onsuccess = () => {
                        const task = request.result;
                        if (task) {
                            task.status = 'failed';
                            task.error = error;
                            store.put(task);
                        }
                    };

                    transaction.oncomplete = () => resolve();
                    transaction.onerror = (e) => {
                        ErrorLogger.log(e.target.error, { taskId, action: 'markTaskFailed' });
                        reject(e.target.error);
                    };
                });
            }

            async updateTaskInDB(task) {
                if (!db) return;

                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([SYNC_STORE], 'readwrite');
                    const store = transaction.objectStore(SYNC_STORE);
                    store.put(task);

                    transaction.oncomplete = () => resolve();
                    transaction.onerror = (e) => {
                        ErrorLogger.log(e.target.error, { task, action: 'updateTaskInDB' });
                        reject(e.target.error);
                    };
                });
            }

            chunkArray(array, size) {
                const chunks = [];
                for (let i = 0; i < array.length; i += size) {
                    chunks.push(array.slice(i, i + size));
                }
                return chunks;
            }
            
            cleanup() {
                if (this.abortController) {
                    this.abortController.abort();
                    this.abortController = null;
                }
            }
        }

        const syncManager = new SyncManager();

        // ===== وظائف قاعدة البيانات المحسنة =====

        async function openDatabase() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    
                    // إضافة معالج الأخطاء لقاعدة البيانات
                    db.onerror = (event) => {
                        console.error('Database error:', event.target.error);
                        ErrorLogger.log(event.target.error, { action: 'database' });
                    };
                    
                    resolve(db);
                };

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;

                    // إنشاء مخزن البيانات الرئيسي
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        const store = db.createObjectStore(STORE_NAME, { keyPath: ['village', 'month'] });
                        store.createIndex('village_month', ['village', 'month'], { unique: true });
                        store.createIndex('timestamp', 'timestamp', { unique: false });
                    }

                    // إنشاء مخزن مهام المزامنة
                    if (!db.objectStoreNames.contains(SYNC_STORE)) {
                        const syncStore = db.createObjectStore(SYNC_STORE, { keyPath: 'id' });
                        syncStore.createIndex('status', 'status', { unique: false });
                        syncStore.createIndex('village', 'village', { unique: false });
                        syncStore.createIndex('createdAt', 'createdAt', { unique: false });
                    }

                    // إنشاء مخزن سجل الأخطاء
                    if (!db.objectStoreNames.contains(ERROR_LOG_STORE)) {
                        const errorStore = db.createObjectStore(ERROR_LOG_STORE, { keyPath: 'id', autoIncrement: true });
                        errorStore.createIndex('timestamp', 'timestamp', { unique: false });
                        errorStore.createIndex('error', 'error', { unique: false });
                    }

                    // إنشاء مخزن إعدادات المستخدم
                    if (!db.objectStoreNames.contains(USER_SETTINGS_STORE)) {
                        const settingsStore = db.createObjectStore(USER_SETTINGS_STORE, { keyPath: 'key' });
                    }
                };
            });
        }

        async function saveDataLocally(village, month, data) {
            if (!db) return;

            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);

                store.put({
                    village: village,
                    month: month,
                    data: data,
                    timestamp: Date.now(),
                    synced: true,
                    dataSize: JSON.stringify(data).length
                });

                transaction.oncomplete = () => resolve();
                transaction.onerror = (e) => {
                    ErrorLogger.log(e.target.error, { village, month, action: 'saveDataLocally' });
                    reject(e.target.error);
                };
            });
        }

        async function getLocalData(village, month) {
            if (!db) return null;

            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.get([village, month]);
                
                request.onsuccess = (e) => {
                    const result = e.target.result;
                    if (result && result.timestamp) {
                        // التحقق من صلاحية البيانات (7 أيام)
                        const dataAge = Date.now() - result.timestamp;
                        if (dataAge < SYNC_CONFIG.offlineTTL) {
                            resolve(result.data);
                        } else {
                            resolve(null); // البيانات منتهية الصلاحية
                        }
                    } else {
                        resolve(null);
                    }
                };
                request.onerror = (e) => {
                    ErrorLogger.log(e.target.error, { village, month, action: 'getLocalData' });
                    reject(e.target.error);
                };
            });
        }

        // ===== وظائف الحسابات الأساسية =====

        function calculateDerivedData(row) {
            const newRow = [...row];
            
            // تحويل جميع القيم الرقمية إلى أرقام
            for (let i = 0; i < newRow.length; i++) {
                if (i >= 2 && i <= 12) {
                    const num = parseFloat(newRow[i]);
                    newRow[i] = isNaN(num) ? "0.00" : num.toFixed(2);
                }
            }
            
            return newRow;
        }

        function recalculateRow(row, updatedColIndex, updatedValue) {
            const newRow = [...row];
            const cleanValue = parseFloat(updatedValue) || 0;
            
            newRow[updatedColIndex] = cleanValue.toFixed(2);
            
            const prevReading = parseFloat(newRow[2]) || 0;
            const currentReading = parseFloat(newRow[3]) || 0;
            const fixedFee = parseFloat(newRow[7]) || FIXED_RATES.fixedFee;
            const lateBalance = parseFloat(newRow[8]) || 0;
            const otherRevenue = parseFloat(newRow[10]) || 0;
            const paidAmount = parseFloat(newRow[11]) || 0;
            
            // تحديث رسوم ثابتة إذا كانت صفر
            if (newRow[7] === "0.00" || newRow[7] === "0") {
                newRow[7] = FIXED_RATES.fixedFee.toFixed(2);
            }
            
            if (updatedColIndex === 3) {
                const consumption = Math.max(0, currentReading - prevReading);
                
                let consF1 = 0;
                let consF2 = 0;
                
                if (consumption > 0) {
                    if (consumption <= FIXED_RATES.threshold) {
                        consF1 = consumption;
                    } else {
                        consF1 = FIXED_RATES.threshold;
                        consF2 = consumption - FIXED_RATES.threshold;
                    }
                }
                
                const valueF1 = consF1 * FIXED_RATES.tariffF1;
                const valueF2 = consF2 * FIXED_RATES.tariffF2;
                const totalConsumptionValue = valueF1 + valueF2;

                newRow[4] = consF1.toFixed(2);
                newRow[5] = consF2.toFixed(2);
                newRow[6] = totalConsumptionValue.toFixed(2);
            }
            
            const totalConsumptionValue = parseFloat(newRow[6]) || 0;
            const fixedFeeUpdated = parseFloat(newRow[7]) || FIXED_RATES.fixedFee;

            const totalRequired = totalConsumptionValue + fixedFeeUpdated + lateBalance + otherRevenue;
            newRow[9] = totalRequired.toFixed(2);

            const remaining = totalRequired - paidAmount;
            newRow[12] = remaining.toFixed(2);

            return newRow;
        }

        function validateCellInput(colIndex, newValue, rowData) {
            const colDef = COLUMN_HEADERS.find(h => h.col === colIndex);

            if (!colDef || !colDef.validation) return { isValid: true, message: "" };

            if (colDef.validation === 'text') {
                return { isValid: true, message: "" };
            }

            const cleanedValue = String(newValue).replace(/,/g, '').trim();
            
            if ((colIndex === 11 || colIndex === 10) && (cleanedValue === "" || cleanedValue === "0")) {
                return { isValid: true, message: "" };
            }

            const numValue = parseFloat(cleanedValue);
            const prevReading = parseFloat(rowData[2]) || 0;
            
            if (isNaN(numValue) && cleanedValue !== "") {
                return { isValid: false, message: "يجب إدخال قيمة رقمية صحيحة." };
            }
            
            if (numValue < 0 && colIndex !== 11 && colIndex !== 10) {
                return { isValid: false, message: "لا يمكن إدخال قيمة سالبة في هذا الحقل." };
            }

            if (colDef.validation === 'reading') {
                if (numValue < prevReading) {
                    return { isValid: false, message: `القراءة الحالية (${numValue}) لا يمكن أن تكون أقل من القراءة السابقة (${prevReading}).` };
                }
            }

            return { isValid: true, message: "" };
        }

        async function saveCell(originalIndex, colIndex, cell) {
            const rowData = dataManager.currentData[originalIndex];
            const colDef = COLUMN_HEADERS.find(h => h.col === colIndex);

            let rawValue = cell.textContent.trim();
            let valueToSend = String(rawValue).replace(/,/g, '').trim();
            
            if ((colIndex === 11 || colIndex === 10) && (valueToSend === "" || valueToSend === "0")) {
                valueToSend = "0";
            }

            const validation = validateCellInput(colIndex, rawValue, rowData);
            if (!validation.isValid) {
                showSaveNotification(false, validation.message);
                const oldValue = dataManager.currentData[originalIndex][colIndex];
                cell.textContent = formatNumber(oldValue, false, colIndex);
                cell.focus();
                return;
            }

            const colLetter = colDef.letter;

            let newRow = rowData;
            if (colIndex !== 13) {
                newRow = recalculateRow(rowData, colIndex, valueToSend);
            }
            
            // تحديث البيانات المحلية
            dataManager.currentData[originalIndex] = newRow;
            dataManager.updateRowCells(originalIndex, newRow);

            // حفظ البيانات محلياً
            await saveDataLocally(villageSelect.value, monthSelect.value, dataManager.currentData);

            // إضافة مهمة مزامنة
            const taskId = await syncManager.addSyncTask({
                sheet: monthSelect.value,
                row: originalIndex + 1,
                col: colLetter,
                value: valueToSend,
                village: villageSelect.value,
                timestamp: Date.now()
            });

            // تحديث واجهة الخلية
            const globalRowIndex = dataManager.filteredData.findIndex(row => row === dataManager.currentData[originalIndex]);
            if (globalRowIndex !== -1) {
                const tableRow = tableBody.rows[globalRowIndex + 1];
                if (tableRow && tableRow.cells[colIndex]) {
                    tableRow.cells[colIndex].classList.add('pending-cell');
                    tableRow.cells[colIndex].title = "تغيير معلق - جاري المزامنة";
                }
            }

            showSaveNotification(true, 'تم حفظ التغيير وجاهز للمزامنة');
            updateStatus('تم حفظ التغيير محلياً وجاهز للمزامنة');
        }

        // ===== وظائف الواجهة المحسنة =====

        function renderTable(data) {
            // تنظيف الجدول القديم
            tableBody.innerHTML = "";

            if (!data || data.length < 3) {
                renderErrorTable('لا توجد بيانات أو نتائج مطابقة.');
                return;
            }

            const headerRow = document.createElement("tr");
            COLUMN_HEADERS.forEach(col => {
                const th = document.createElement("th");
                th.style.width = col.width || 'auto';
                th.innerHTML = `<i class="${col.icon}"></i> ${col.letter} <br> <span>${col.label}</span>`;
                headerRow.appendChild(th);
            });
            tableBody.appendChild(headerRow);

            data.forEach((row, rIndex) => {
                if (rIndex === 0) return;

                const tr = document.createElement("tr");
                const originalIndex = dataManager.currentData.findIndex(d => d === row);
                const isTotalRow = originalIndex === dataManager.totalRowIndex;
                const isInfoRow = originalIndex === 1;
                const isDataRow = originalIndex >= 2 && !isTotalRow;
                
                const consumptionF2 = parseFloat(row[5]) || 0;

                if (isTotalRow) {
                    tr.classList.add("total-row");
                }
                
                if (consumptionF2 > 0 && isDataRow) {
                    tr.style.backgroundColor = 'rgba(0, 180, 216, 0.1)';
                    tr.style.borderRight = '4px solid var(--secondary)';
                }

                if (isInfoRow) {
                    tr.style.backgroundColor = '#f0f0f0';
                    tr.style.fontWeight = 'bold';
                    tr.style.color = 'var(--primary)';
                }

                COLUMN_HEADERS.forEach((colDef, c) => {
                    const td = document.createElement("td");
                    let cellValue = row[c] !== undefined ? row[c] : "";

                    if (c === 0) td.classList.add('col-a-bg');
                    if (c === 1) td.classList.add('col-b-bg');

                    if (c === 0 || (c >= 2 && c <= 12)) {
                        td.textContent = formatNumber(cellValue, false, c);
                        td.classList.add("number-cell");
                    } else {
                        td.textContent = cellValue;
                    }

                    if (c === 1) {
                        td.classList.add("name-cell");
                    }

                    if (c === 5 && consumptionF2 > 0) {
                        td.style.backgroundColor = 'var(--secondary)';
                        td.style.color = 'white';
                        td.style.fontWeight = 'bold';
                    }

                    if (c === 12 && !isNaN(row[c]) && parseFloat(row[c]) >= LATE_BALANCE_THRESHOLD && isDataRow) {
                        td.style.backgroundColor = 'var(--danger)';
                        td.style.color = 'white';
                        td.style.fontWeight = 'bold';
                    }

                    if (colDef.editable && isDataRow) {
                        td.classList.add("editable");
                        td.contentEditable = true;
                        td.setAttribute('data-original-index', originalIndex);

                        td.onfocus = () => {
                            tr.classList.add('active-row');
                            
                            let raw = String(row[c] || "").replace(/,/g, '').trim();
                            
                            if (c === 3 || c === 11 || c === 10) {
                                if ((c === 11 || c === 10) && (raw === "0.00" || raw === "0" || raw === "")) {
                                    td.textContent = "";
                                } else {
                                    td.textContent = parseFloat(raw) || "";
                                }
                            } else {
                                td.textContent = raw;
                            }
                            
                            const range = document.createRange();
                            range.selectNodeContents(td);
                            const selection = window.getSelection();
                            selection.removeAllRanges();
                            selection.addRange(range);
                        };

                        td.onblur = () => {
                            tr.classList.remove('active-row');
                            debouncedSaveCell(originalIndex, c, td);
                        };

                        td.onkeypress = (e) => {
                            if (colDef.validation !== 'text' && (e.charCode < 48 || e.charCode > 57) && e.charCode !== 46 && e.key !== 'Enter') {
                                e.preventDefault();
                            }
                            if (e.key === 'Enter') {
                                e.preventDefault();
                                td.blur();
                            }
                        };

                        // تحقق من المهام المعلقة
                        syncManager.getPendingTasksFromDB().then(tasks => {
                            const pendingTask = tasks.find(t => t.row === originalIndex + 1 && COLUMN_HEADERS.find(h => h.col === c).letter === t.col);
                            if (pendingTask) {
                                td.classList.add('pending-cell');
                                td.title = "تغيير معلق - جاري المزامنة";
                            }
                        }).catch(err => {
                            console.error('Error checking pending tasks:', err);
                        });
                    }
                    
                    if (isInfoRow) {
                        td.contentEditable = false;
                    }

                    tr.appendChild(td);
                });

                tableBody.appendChild(tr);
            });
            
            // إضافة حدث التركيز للصفوف الجديدة
            if (focusManager.isActive) {
                document.querySelectorAll('#dataTable tr:not(:first-child):not(:last-child)').forEach(tr => {
                    tr.style.cursor = 'pointer';
                    tr.title = 'انقر للتركيز على هذا المشترك';
                });
            }
        }

        function renderErrorTable(message) {
            tableBody.innerHTML = `<tr><td colspan="14" style="text-align:center;padding:30px;color:#999;font-size:1.1rem;">
                    <i class="fas fa-exclamation-triangle fa-2x"></i><br>
                    <span style="font-weight:700;">${message}</span>
                </td></tr>`;
        }

        function debouncedSaveCell(originalIndex, colIndex, cell) {
            const cellKey = `${originalIndex}_${colIndex}`;

            const currentRawValue = cell.textContent.trim();
            const oldValue = dataManager.currentData[originalIndex][colIndex];

            const cleanedOldValue = String(oldValue).replace(/,/g, '').trim();
            const cleanedCurrentValue = String(currentRawValue).replace(/,/g, '').trim();
            
            let isUnchanged = false;
            
            if (colIndex === 11 || colIndex === 10) {
                const numOld = parseFloat(cleanedOldValue) || 0;
                const numCurrent = parseFloat(cleanedCurrentValue) || 0;
                
                if ((cleanedCurrentValue === "" || numCurrent === 0) && (cleanedOldValue === "0.00" || numOld === 0)) {
                    isUnchanged = true;
                } else {
                    isUnchanged = (cleanedCurrentValue === cleanedOldValue);
                }
            } else if (colIndex === 3) {
                isUnchanged = (cleanedCurrentValue === cleanedOldValue);
            } else {
                isUnchanged = (cleanedCurrentValue === cleanedOldValue);
            }
            
            if (isUnchanged) {
                cell.textContent = formatNumber(cleanedOldValue, false, colIndex);
                if (cellSaveTimers.has(cellKey)) {
                    clearTimeout(cellSaveTimers.get(cellKey).timerId);
                    cellSaveTimers.delete(cellKey);
                }
                return;
            }
            
            cell.textContent = formatNumber(cleanedCurrentValue, false, colIndex);

            if (cellSaveTimers.has(cellKey)) {
                clearTimeout(cellSaveTimers.get(cellKey).timerId);
                cellSaveTimers.delete(cellKey);
            }

            const timerId = setTimeout(() => {
                saveCell(originalIndex, colIndex, cell);
                cellSaveTimers.delete(cellKey);
            }, SAVE_DELAY);

            cellSaveTimers.set(cellKey, { timerId, createdAt: Date.now() });
        }

        // ===== وظائف المساعدة المحسنة =====

        function formatNumber(value, currency = false, colIndex = -1) {
            if (value === null || value === undefined || value === "") return "";
            
            const cleanValue = String(value).replace(/,/g, '').trim();

            const num = parseFloat(cleanValue);
            if (isNaN(num)) return value;
            
            if (colIndex === 3 || colIndex === 11 || colIndex === 10) {
                if ((colIndex === 11 || colIndex === 10) && num === 0) return "";
                
                if (colIndex === 3 && num === 0) return "0";
                
                return num.toFixed(0).replace(/,/g, '');
            }

            const needsDecimal = (colIndex >= 4 && colIndex <= 12) || (num % 1 !== 0);
            
            const fractionDigits = needsDecimal ? 2 : 0;
            
            const formatted = num.toLocaleString('en-US', {
                maximumFractionDigits: fractionDigits,
                minimumFractionDigits: fractionDigits,
            });
            
            return formatted;
        }

        function showSaveNotification(isSuccess = true, message = '') {
            const saveNotification = document.getElementById('saveNotification');
            saveNotification.innerHTML = `<i class="fas fa-${isSuccess ? 'check' : 'exclamation'}-circle"></i><span>${message}</span>`;
            saveNotification.className = `save-notification ${isSuccess ? '' : 'error'}`;
            saveNotification.classList.add('show');

            setTimeout(() => saveNotification.classList.remove('show'), 3000);
        }

        function showToast(message, type = 'info', duration = 5000) {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = 'toast';
            
            const icon = type === 'error' ? 'exclamation-circle' : 
                        type === 'success' ? 'check-circle' : 
                        type === 'warning' ? 'exclamation-triangle' : 'info-circle';
            
            toast.innerHTML = `
                <i class="fas fa-${icon}" style="color: var(--${type})"></i>
                <span>${message}</span>
            `;
            
            toastContainer.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideInRight 0.3s ease-out reverse';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        function updateOnlineStatus() {
            if (navigator.onLine) {
                onlineStatusEl.textContent = "متصل بالشبكة";
                onlineStatusEl.className = 'online';
                updateStatus('متصل بالشبكة - جاهز للمزامنة');

                setTimeout(() => {
                    syncManager.syncImmediately();
                    dataManager.loadData(false);
                }, 1000);

            } else {
                onlineStatusEl.textContent = "غير متصل بالشبكة";
                onlineStatusEl.className = 'offline';
                syncManager.hideSyncIndicator();
                updateStatus('غير متصل. تعمل في وضع عدم الاتصال (بيانات محلية)', false, true);
            }
        }

        function updateStatus(status, isSaving = false, isError = false) {
            const now = new Date().toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            statusText.textContent = `${status} - ${now}`;

            statusIndicator.classList.remove('saving', 'saved', 'error');
            if (isSaving) {
                statusIndicator.classList.add('saving');
            } else if (isError) {
                statusIndicator.classList.add('error');
            } else {
                statusIndicator.classList.add('saved');
            }
        }

        function autoRefreshToggle() {
            isAutoRefresh = !isAutoRefresh;

            if (isAutoRefresh) {
                autoRefreshBtn.innerHTML = '<i class="fas fa-sync fa-spin"></i> التحديث التلقائي: مفعل';
                autoRefreshBtn.style.backgroundColor = 'var(--success)';
                dataManager.startAutoRefresh();
            } else {
                autoRefreshBtn.innerHTML = '<i class="fas fa-sync"></i> التحديث التلقائي: غير مفعل';
                autoRefreshBtn.style.backgroundColor = '#17a2b8';
                dataManager.stopAutoRefresh();
            }
        }

        function setDefaultMonth() {
            const today = new Date();
            const currentMonth = today.getMonth() + 1;
            const monthOption = `شهر ${currentMonth}`;

            for (let i = 0; i < monthSelect.options.length; i++) {
                if (monthSelect.options[i].value === monthOption) {
                    monthSelect.selectedIndex = i;
                    break;
                }
            }
        }

        function startPreloadData() {
            const villages = Object.keys(villageAPIs);
            const monthOptions = Array.from(monthSelect.options).map(opt => opt.value);

            const preloadBtn = document.getElementById('preloadBtn');
            preloadBtn.disabled = true;
            preloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري التحميل...';

            const totalTasks = villages.length * monthOptions.length;
            let completedTasks = 0;
            let failedTasks = 0;

            const runPreload = async () => {
                try {
                    updateStatus(`بدء التحميل المسبق لـ ${totalTasks} مهمة...`, true);

                    for (const village of villages) {
                        const apiURL = villageAPIs[village];
                        for (const month of monthOptions) {
                            completedTasks++;
                            const progress = `${completedTasks}/${totalTasks}`;
                            updateStatus(`جاري تحميل: ${village} - ${month} (${progress})`, true);

                            try {
                                if (!navigator.onLine) {
                                    console.log(`تخطي ${village} - ${month} (غير متصل)`);
                                    continue;
                                }

                                const timestamp = new Date().getTime();
                                const res = await fetch(`${apiURL}?sheet=${encodeURIComponent(month)}&t=${timestamp}`);
                                const rawData = await res.json();

                                if (rawData && rawData.error) throw new Error(rawData.error);

                                await saveDataLocally(village, month, rawData);
                                console.log(`تم تحميل: ${village} - ${month}`);

                            } catch (error) {
                                console.warn(`فشل تحميل: ${village} - ${month}`, error.message);
                                ErrorLogger.log(error, { village, month, action: 'preload' });
                                failedTasks++;
                            }
                        }
                    }

                    if (failedTasks === 0) {
                        showSaveNotification(true, `اكتمل التحميل المسبق بنجاح لـ ${totalTasks} مهمة!`);
                        showToast('اكتمل التحميل المسبق بنجاح!', 'success');
                    } else {
                        showSaveNotification(false, `اكتمل التحميل المسبق مع ${failedTasks} فشل. يرجى مراجعة الاتصال.`);
                        showToast(`اكتمل التحميل مع ${failedTasks} فشل`, 'warning');
                    }

                    updateStatus('اكتمل التحميل المسبق وجاهز للعمل دون اتصال');

                } catch (globalError) {
                    console.error('خطأ عام:', globalError);
                    ErrorLogger.log(globalError, { action: 'preloadGlobal' });
                    showSaveNotification(false, 'فشل عام في عملية التحميل المسبق.');
                    showToast('فشل في عملية التحميل المسبق', 'error');
                    updateStatus('فشل عام في التحميل المسبق', false, true);
                } finally {
                    preloadBtn.disabled = false;
                    preloadBtn.innerHTML = '<i class="fas fa-download"></i> تحميل البيانات للعمل بدون نت';
                    
                    // تنظيف الذاكرة بعد التحميل المسبق
                    setTimeout(() => memoryMonitor.forceCleanup(), 2000);
                }
            };

            runPreload();
        }

        function printTable() { 
            window.print(); 
        }

        // ===== الرسوم البيانية والتنبيهات =====

        function initCharts(metrics, activeData) {
            // تنظيف الرسوم البيانية القديمة
            if (consumptionChartInstance) {
                consumptionChartInstance.destroy();
            }
            if (paymentChartInstance) {
                paymentChartInstance.destroy();
            }
            
            const consumptionCtx = document.getElementById('consumptionChart')?.getContext('2d');
            const paymentCtx = document.getElementById('paymentChart')?.getContext('2d');

            if (!consumptionCtx || !paymentCtx) return;

            const ranges = {
                '1-8 م³': 0,
                '9م³ فأكثر': 0,
                'صفر/سالب': 0
            };

            activeData.forEach(row => {
                const consF1 = parseFloat(row[4]) || 0;
                const consF2 = parseFloat(row[5]) || 0;
                
                if (consF1 > 0 || consF2 > 0) {
                    if (consF2 > 0) {
                        ranges['9م³ فأكثر']++;
                    } else if (consF1 > 0) {
                        ranges['1-8 م³']++;
                    }
                } else {
                    ranges['صفر/سالب']++;
                }
            });

            consumptionChartInstance = new Chart(consumptionCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(ranges),
                    datasets: [{
                        label: 'عدد المشتركين',
                        data: Object.values(ranges),
                        backgroundColor: [
                            'rgba(144, 224, 239, 0.8)',
                            'rgba(0, 119, 182, 0.8)',
                            'rgba(220, 53, 69, 0.8)'
                        ],
                        borderColor: 'white',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });

            const remaining = metrics.totalRemaining || 0;
            const paid = metrics.totalPaid || 0;

            paymentChartInstance = new Chart(paymentCtx, {
                type: 'doughnut',
                data: {
                    labels: ['المسدّد', 'المتبقي'],
                    datasets: [{
                        data: [paid, remaining],
                        backgroundColor: ['var(--success)', 'var(--danger)'],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: 'حالة الدفع (ريال)' },
                    }
                }
            });
        }

        function updateAlerts(activeData) {
            toggleAlertsBtn = toggleAlertsBtn || document.getElementById('toggleAlertsBtn');

            const highBalanceRows = activeData.filter(row => (parseFloat(row[12]) || 0) >= LATE_BALANCE_THRESHOLD);
            const reverseReadingRows = activeData.filter(row => (parseFloat(row[3]) || 0) < (parseFloat(row[2]) || 0));
            const zeroConsumptionRows = activeData.filter(row => (parseFloat(row[4]) || 0) <= 0 && (parseFloat(row[5]) || 0) <= 0);

            let alertsList = "";
            let totalAlerts = 0;

            highBalanceRows.forEach(row => {
                alertsList += `<li class="error-item">المشترك **${row[1]}** (عداد: ${row[0]}) متبقي عليه **${formatNumber(row[12], false, 12)}**</li>`;
                totalAlerts++;
            });

            reverseReadingRows.forEach(row => {
                alertsList += `<li class="error-item">قراءة عكسية للمشترك **${row[1]}**: حالية ${formatNumber(row[3], false, 3)} < سابقة ${formatNumber(row[2], false, 2)}</li>`;
                totalAlerts++;
            });

            zeroConsumptionRows.forEach(row => {
                alertsList += `<li class="warning-item">المشترك **${row[1]}** (عداد: ${row[0]}) استهلاكه **صفر/سالب** (يجب التأكد من العداد).</li>`;
                totalAlerts++;
            });

            if (totalAlerts > 0) {
                alertSection.innerHTML = `
                    <p style="font-weight: 700;"><i class="fas fa-exclamation-circle"></i> تنبيهات وملاحظات (${totalAlerts}):</p>
                    <ul>${alertsList}</ul>
                `;

                if (alertsVisible) {
                    alertSection.style.display = 'block';
                }

                if (toggleAlertsBtn) {
                    toggleAlertsBtn.innerHTML = alertsVisible ? '<i class="fas fa-eye-slash"></i> إخفاء التنبيهات' : '<i class="fas fa-eye"></i> إظهار التنبيهات';
                    toggleAlertsBtn.style.backgroundColor = alertsVisible ? 'var(--secondary)' : 'var(--info)';
                }

            } else {
                alertSection.style.display = 'none';
                if (toggleAlertsBtn) {
                    alertsVisible = false;
                    toggleAlertsBtn.innerHTML = '<i class="fas fa-eye"></i> إظهار التنبيهات';
                    toggleAlertsBtn.style.backgroundColor = 'var(--info)';
                }
            }
        }

        function toggleAlertsDisplay() {
            const alertSection = document.getElementById('alertSection');
            toggleAlertsBtn = toggleAlertsBtn || document.getElementById('toggleAlertsBtn');

            alertsVisible = !alertsVisible;

            if (alertsVisible) {
                if (alertSection.innerHTML.trim() !== "" && alertSection.querySelector('ul')?.children.length > 0) {
                    alertSection.style.display = 'block';
                }
                toggleAlertsBtn.innerHTML = '<i class="fas fa-eye-slash"></i> إخفاء التنبيهات';
                toggleAlertsBtn.style.backgroundColor = 'var(--secondary)';
            } else {
                alertSection.style.display = 'none';
                toggleAlertsBtn.innerHTML = '<i class="fas fa-eye"></i> إظهار التنبيهات';
                toggleAlertsBtn.style.backgroundColor = 'var(--info)';
            }
        }
        
        // ===== ميزة الذكاء الاصطناعي المحسنة =====
        const AI_ANALYSIS_FUNCTION = {
            
            generateReport: function() {
                aiAnalysisSection.style.display = 'block';
                aiAnalysisContent.innerHTML = `<div style="text-align: center; color: var(--ai-color); padding: 20px;">
                    <div class="spinner"></div>
                    <p style="margin-top: 10px;">جاري تحليل بيانات ${villageSelect.value} لشهر ${monthSelect.value}...</p>
                </div>`;
                aiAnalysisBtn.disabled = true;

                setTimeout(() => {
                    try {
                        const report = this._analyzeData();
                        this._renderReport(report);
                    } catch (error) {
                        console.error('Error generating AI report:', error);
                        ErrorLogger.log(error, { action: 'generateAIReport' });
                        aiAnalysisContent.innerHTML = `<div style="text-align: center; color: var(--danger); padding: 20px;">
                            <i class="fas fa-exclamation-triangle fa-2x"></i>
                            <p style="margin-top: 10px;">حدث خطأ أثناء توليد التقرير. يرجى المحاولة لاحقاً.</p>
                        </div>`;
                    }
                    aiAnalysisBtn.disabled = false;
                }, 1500);
            },

            _analyzeData: function() {
                const metrics = dataManager.metrics;
                const activeData = dataManager.activeData;
                const villageName = villageSelect.value;
                const monthName = monthSelect.value;

                if (activeData.length === 0) {
                    return { 
                        summary: `لا توجد بيانات للمشتركين في قرية ${villageName} لهذا الشهر. يرجى التأكد من تحميل البيانات أولاً.`, 
                        recommendations: [],
                        stats: {}
                    };
                }

                const totalRequired = metrics.totalRequired || 0;
                const totalPaid = metrics.totalPaid || 0;
                const collectionRate = metrics.collectionRate || 0;
                const totalSubscribers = metrics.totalSubscribers || 0;
                const totalConsumption = metrics.totalConsumption || 0;
                const totalHighConsumption = metrics.totalHighConsumption || 0;
                
                const highBalanceRows = activeData.filter(row => (parseFloat(row[12]) || 0) >= LATE_BALANCE_THRESHOLD);
                const highConsumptionRows = activeData.filter(row => (parseFloat(row[5]) || 0) > 0);
                const zeroConsumptionCount = activeData.filter(row => (parseFloat(row[4]) || 0) <= 0 && (parseFloat(row[5]) || 0) <= 0).length;
                const reverseReadings = activeData.filter(row => (parseFloat(row[3]) || 0) < (parseFloat(row[2]) || 0));

                const stats = {
                    totalRequired,
                    totalPaid,
                    collectionRate,
                    totalSubscribers,
                    totalConsumption,
                    totalHighConsumption,
                    highBalanceCount: highBalanceRows.length,
                    highConsumptionCount: highConsumptionRows.length,
                    zeroConsumptionCount,
                    reverseReadingsCount: reverseReadings.length,
                    averageConsumption: totalConsumption / totalSubscribers,
                    averageRemaining: metrics.totalRemaining / totalSubscribers
                };

                let summary = `
                    <p style="font-size: 1.1rem; font-weight: 500; border-bottom: 2px solid var(--primary); padding-bottom: 10px;">
                        📊 ملخص الأداء المالي والتشغيلي لقرية **${villageName}** في **${monthName}**
                    </p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;">
                        <div style="background: rgba(0, 119, 182, 0.1); padding: 15px; border-radius: 8px;">
                            <div style="font-size: 0.9rem; color: var(--text-light);">معدل التحصيل</div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: ${collectionRate >= 90 ? 'var(--success)' : collectionRate >= 70 ? 'var(--warning)' : 'var(--danger)'};">${formatNumber(collectionRate, false)}%</div>
                        </div>
                        <div style="background: rgba(40, 167, 69, 0.1); padding: 15px; border-radius: 8px;">
                            <div style="font-size: 0.9rem; color: var(--text-light);">المشتركين المتأخرين</div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--danger);">${highBalanceRows.length}</div>
                        </div>
                        <div style="background: rgba(255, 193, 7, 0.1); padding: 15px; border-radius: 8px;">
                            <div style="font-size: 0.9rem; color: var(--text-light);">الاستهلاك العالي</div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--warning);">${highConsumptionRows.length}</div>
                        </div>
                    </div>
                    <p>
                        بلغ إجمالي الإيرادات المطلوبة لهذا الشهر **${formatNumber(totalRequired)}** ريال، تم تحصيل **${formatNumber(totalPaid)}** ريال منها، 
                        بمعدل تحصيل يبلغ **${formatNumber(collectionRate, false)}%**.
                    </p>
                    <p>
                        إجمالي الاستهلاك بلغ **${formatNumber(totalConsumption)}** متر مكعب، وشارك **${highConsumptionRows.length}** مشترك
                        في استهلاك الفئة العليا (9م³ فأكثر)، بإجمالي **${formatNumber(totalHighConsumption)}** م³.
                    </p>
                `;

                let recommendations = [];

                if (collectionRate < 70) {
                    recommendations.push({
                        title: `🚨 توصية مالية عاجلة: رفع معدل التحصيل (المعدل الحالي: ${formatNumber(collectionRate, false)}%)`,
                        detail: `معدل التحصيل منخفض جداً. يجب التركيز على المشتركين المتأخرين الذين يتجاوز عددهم **${highBalanceRows.length}** مشترك. يوصى بإرسال تنبيهات عاجلة لهذه المجموعة.`,
                        priority: 'high'
                    });
                } else if (collectionRate < 95) {
                     recommendations.push({
                        title: `📈 توصية مالية: تحسين الأداء (المعدل الحالي: ${formatNumber(collectionRate, false)}%)`,
                        detail: `معدل التحصيل جيد لكن ما زالت هناك فرصة لزيادته. استهدف المشتركين الأقل تأخراً لتقليل الرصيد المتبقي الإجمالي.`,
                        priority: 'medium'
                    });
                } else {
                     recommendations.push({
                        title: `✅ تقييم مالي ممتاز! (المعدل: ${formatNumber(collectionRate, false)}%)`,
                        detail: `أداء التحصيل لهذا الشهر ممتاز، حافظ على نفس الإجراءات المتبعة لضمان استمرار هذا المستوى.`,
                        priority: 'low'
                    });
                }

                if (totalHighConsumption > totalConsumption * 0.3) {
                    recommendations.push({
                        title: `💧 توصية تشغيلية: مراقبة الاستهلاك العالي`,
                        detail: `ما يقارب ${Math.round((totalHighConsumption / totalConsumption) * 100)}% من إجمالي الاستهلاك يقع في الفئة العليا. يجب مراجعة العدادات في هذه الفئة للتأكد من عدم وجود تسربات كبيرة أو سوء استخدام.`,
                        priority: 'medium'
                    });
                }

                if (zeroConsumptionCount > totalSubscribers * 0.1) {
                    recommendations.push({
                        title: `🔧 توصية فنية: التحقق من عدادات الاستهلاك الصفري/السلبي`,
                        detail: `يوجد **${zeroConsumptionCount}** مشترك باستهلاك صفري أو سلبي (تقريباً ${Math.round((zeroConsumptionCount / totalSubscribers) * 100)}% من المشتركين). يوصى بزيارة الموقع للتحقق من عدادات هؤلاء المشتركين (التوقف أو القراءة العكسية).`,
                        priority: 'high'
                    });
                }

                if (reverseReadings.length > 0) {
                    recommendations.push({
                        title: `⚠️ مشكلة فنية: قراءات عكسية`,
                        detail: `تم رصد **${reverseReadings.length}** حالة قراءة عكسية. هذا يشير إلى مشكلة في العدادات أو تسجيل القراءات.`,
                        priority: 'high'
                    });
                }

                // تحليل متوسط الاستهلاك
                if (stats.averageConsumption < 5) {
                    recommendations.push({
                        title: `📉 تحليل: متوسط استهلاك منخفض`,
                        detail: `متوسط الاستهلاك لكل مشترك هو ${formatNumber(stats.averageConsumption)} م³. قد يشير هذا إلى كفاءة في الاستهلاك أو مشاكل في العدادات.`,
                        priority: 'low'
                    });
                }

                return { summary, recommendations, stats };
            },

            _renderReport: function(report) {
                let html = `
                    <div style="font-size: 1.1rem; margin-bottom: 20px;">
                        ${report.summary}
                    </div>
                    
                    <h3 style="color: var(--ai-color); border-bottom: 2px solid var(--ai-color); padding-bottom: 10px;">
                        <i class="fas fa-lightbulb"></i> توصيات الذكاء الاصطناعي والإجراءات المقترحة
                    </h3>
                    <div style="margin-top: 20px;">
                `;

                if (report.recommendations && report.recommendations.length > 0) {
                    // ترتيب حسب الأولوية
                    const sortedRecs = report.recommendations.sort((a, b) => {
                        const priorityOrder = { high: 0, medium: 1, low: 2 };
                        return priorityOrder[a.priority] - priorityOrder[b.priority];
                    });

                    sortedRecs.forEach(rec => {
                        const priorityColor = rec.priority === 'high' ? 'var(--danger)' : 
                                            rec.priority === 'medium' ? 'var(--warning)' : 'var(--success)';
                        
                        html += `
                            <div style="background: ${priorityColor}10; border-right: 4px solid ${priorityColor}; padding: 15px; margin-bottom: 15px; border-radius: 8px;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                    <span style="background: ${priorityColor}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem;">
                                        ${rec.priority === 'high' ? 'عالي' : rec.priority === 'medium' ? 'متوسط' : 'منخفض'}
                                    </span>
                                    <strong style="color: ${priorityColor};">${rec.title}</strong>
                                </div>
                                <p style="font-size: 0.95rem; color: var(--text-dark); margin: 0;">${rec.detail}</p>
                            </div>
                        `;
                    });
                } else {
                    html += `<div style="text-align: center; padding: 20px; color: var(--text-light);">
                        <i class="fas fa-check-circle fa-2x"></i>
                        <p style="margin-top: 10px;">لا توجد توصيات محددة في الوقت الحالي. الأداء يبدو مستقراً.</p>
                    </div>`;
                }

                html += `</div>`;
                aiAnalysisContent.innerHTML = html;
            }
        };

        // ===== وظائف تقرير القرى الشهري المحسنة =====
        const MONTHLY_REPORT_DATA_URL = 'https://script.google.com/macros/s/AKfycbwCLB2B8LGwefWiNDacjM4YX8N86NWu-GgM8i6V3cm0PkxG-OQ1bFiNNuPyYHuvwnLXvA/exec';

        let monthlyData = {};
        let currentMonth = "";
        let searchTerm = "";
        let highlightedRows = new Set();
        let villageNames = [];

        async function fetchMonthlyReportData() {
            try {
                document.getElementById('dataSourceMessage').innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> جاري جلب البيانات من المصدر...';
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000);
                
                const response = await fetch(MONTHLY_REPORT_DATA_URL, {
                    signal: controller.signal,
                    cache: 'no-cache'
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`خطأ في السيرفر: ${response.status}`);
                }
                
                const rawData = await response.json();
                
                if (typeof rawData !== 'object' || rawData === null) {
                    throw new Error("تنسيق البيانات غير صحيح. يجب أن يكون كائناً (JSON).");
                }
                
                monthlyData = rawData;
                initializeMonthlyReportApp();
                
                document.getElementById('dataSourceMessage').innerHTML = `<i class="fas fa-check-circle"></i> تم تحديث البيانات في ${new Date().toLocaleTimeString('ar-EG')}`;
                
            } catch (error) {
                console.error("خطأ في جلب البيانات:", error);
                ErrorLogger.log(error, { action: 'fetchMonthlyReport' });
                
                document.getElementById('tableContent').innerHTML = `
                    <div class="monthly-report-no-data">
                        <i class="fas fa-times-circle fa-2x"></i><br>
                        <h3 style="color: var(--danger); margin: 15px 0;">فشل في جلب البيانات من المصدر.</h3>
                        <p>السبب: ${error.message}</p>
                        <button onclick="fetchMonthlyReportData()" style="
                            margin-top: 20px;
                            padding: 10px 20px;
                            background-color: var(--primary);
                            color: white;
                            border: none;
                            border-radius: 8px;
                            cursor: pointer;
                        ">
                            <i class="fas fa-redo"></i> إعادة المحاولة
                        </button>
                    </div>`;
                document.getElementById('tableTitle').textContent = `خطأ في تحميل التقرير`;
                document.getElementById('dataSourceMessage').innerHTML = `<i class="fas fa-times-circle"></i> فشل الاتصال بالمصدر الخارجي.`;
            }
        }

        function initializeMonthlyReportApp() {
            const availableMonths = Object.keys(monthlyData).filter(key => key !== "الإجمالي الكلي");
            if (availableMonths.length === 0) {
                 document.getElementById('tableContent').innerHTML = `<div class="monthly-report-no-data">
                     <i class="fas fa-exclamation-triangle fa-2x"></i><br>
                     <h3 style="margin: 15px 0;">لم يتم العثور على أي بيانات شهرية.</h3>
                     <p>قد يكون المصدر فارغاً أو لم يتم تحديثه بعد.</p>
                 </div>`;
                 return;
            }

            currentMonth = availableMonths[0];
            buildMonthSelector(availableMonths);
            updateMonthlyReportStats();
            renderMonthlyReportTable(currentMonth);
            document.getElementById('monthlyReportSearchInput').disabled = false;
            
            // إضافة حدث البحث
            const searchInput = document.getElementById('monthlyReportSearchInput');
            searchInput.addEventListener('input', function(e) {
                searchTerm = e.target.value.trim().toLowerCase();
                filterMonthlyReportTable(searchTerm);
            });
        }

        function buildMonthSelector(months) {
            const selector = document.getElementById('monthSelector');
            selector.innerHTML = '';
            
            const totalBtn = document.createElement('button');
            totalBtn.className = 'monthly-report-month-btn total';
            totalBtn.textContent = 'الإجمالي الكلي';
            totalBtn.setAttribute('data-month', 'الإجمالي الكلي');
            totalBtn.addEventListener('click', () => changeMonth('الإجمالي الكلي'));
            selector.appendChild(totalBtn);

            months.forEach(month => {
                const monthBtn = document.createElement('button');
                monthBtn.className = 'monthly-report-month-btn';
                if (month === currentMonth) {
                    monthBtn.classList.add('active');
                }
                monthBtn.textContent = month;
                monthBtn.setAttribute('data-month', month);
                monthBtn.addEventListener('click', () => changeMonth(month));
                selector.appendChild(monthBtn);
            });
        }

        function changeMonth(month) {
            document.querySelectorAll('.monthly-report-month-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const selectedBtn = document.querySelector(`.monthly-report-month-btn[data-month="${month}"]`);
            if (selectedBtn) {
                selectedBtn.classList.add('active');
            }
            
            currentMonth = month;
            renderMonthlyReportTable(month);
            
            if (searchTerm) {
                filterMonthlyReportTable(searchTerm);
            } else {
                clearHighlights();
            }
        }

        function renderMonthlyReportTable(month) {
            const tableContent = document.getElementById('tableContent');
            const tableTitle = document.getElementById('tableTitle');
            
            const data = monthlyData[month];

            if (!data || data.length < 3) {
                tableContent.innerHTML = '<div class="monthly-report-no-data"><i class="fas fa-exclamation-circle"></i><br>لا توجد بيانات لهذا الشهر حاليًا.</div>';
                tableTitle.textContent = `بيانات غير متاحة لـ ${month}`;
                return;
            }
            
            tableTitle.textContent = data[0][1] || `تقرير ${month}`;
            
            let html = '<table class="monthly-report-table"><thead><tr>';
            data[1].forEach(header => {
                html += `<th>${header || '---'}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            for (let i = 2; i < data.length; i++) {
                const row = data[i];
                const isTotalRow = i === data.length - 1;
                const rowClass = isTotalRow ? 'total-row' : '';
                
                html += `<tr class="${rowClass}" data-village="${row[1] || ''}">`;
                
                row.forEach((cell, cellIndex) => {
                    let cellClass = '';
                    let cellContent = cell;
                    
                    if (typeof cellContent === 'number') {
                        if (cellContent >= 1000 || cellContent <= -1000) {
                            cellContent = cellContent.toLocaleString('ar-EG');
                        }
                        
                        if (cellIndex === 2 || cellIndex === 3 || cellIndex === 4 || cellIndex === 9) {
                            if (cellContent > 0) {
                                cellClass = 'monthly-report-positive';
                            } else if (cellContent < 0) {
                                cellClass = 'monthly-report-negative';
                            }
                        }
                    }
                    
                    if (isTotalRow) {
                        cellClass += ' total-cell';
                    }
                    
                    html += `<td class="${cellClass}">${cellContent}</td>`;
                });
                
                html += '</tr>';
            }
            html += '</tbody></table>';
            
            tableContent.innerHTML = html;
        }

        function filterMonthlyReportTable(term) {
            const rows = document.querySelectorAll('#tableContent tbody tr:not(.total-row)');
            highlightedRows.clear();
            
            rows.forEach((row, index) => {
                const cells = row.querySelectorAll('td');
                let found = false;
                cells.forEach(cell => {
                    if (cell.textContent.toLowerCase().includes(term.toLowerCase())) {
                        found = true;
                    }
                });
                
                if (found) {
                    row.classList.add('monthly-report-highlight');
                    highlightedRows.add(index);
                } else {
                    row.classList.remove('monthly-report-highlight');
                }
            });
            
            const allRows = document.querySelectorAll('#tableContent tbody tr');
            allRows.forEach((row, index) => {
                if (row.classList.contains('total-row')) return;
                
                if (term && !highlightedRows.has(index - 2)) {
                    row.style.display = 'none';
                } else {
                    row.style.display = '';
                }
            });
            
            updateMonthlyReportSearchStats(term);
        }

        function clearHighlights() {
            const rows = document.querySelectorAll('#tableContent tbody tr');
            rows.forEach(row => {
                row.classList.remove('monthly-report-highlight');
                row.style.display = '';
            });
            highlightedRows.clear();
            document.getElementById('monthlyReportSearchInput').placeholder = "ابحث باسم القرية...";
        }

        function updateMonthlyReportSearchStats(term) {
            const searchCount = highlightedRows.size;
            const searchInput = document.getElementById('monthlyReportSearchInput');
            
            if (term && searchCount > 0) {
                searchInput.placeholder = `تم العثور على ${searchCount} نتيجة`;
            } else if (term) {
                searchInput.placeholder = "لم يتم العثور على نتائج";
            }
        }

        function updateMonthlyReportStats() {
            const availableMonthsKeys = Object.keys(monthlyData).filter(key => key !== "الإجمالي الكلي");
            
            if (availableMonthsKeys.length === 0) {
                 document.getElementById('total-villages').textContent = 0;
                 document.getElementById('total-months').textContent = 0;
                 document.getElementById('total-remaining').textContent = '0';
                 document.getElementById('last-month').textContent = 'لا يوجد';
                 return;
            }

            const lastMonthKey = availableMonthsKeys[availableMonthsKeys.length - 1];
            const lastMonthData = monthlyData[lastMonthKey];
            const lastTotalRow = lastMonthData[lastMonthData.length - 1];
            
            const villageCount = lastMonthData.length - 3; // ناقص رأس الجدول والصف الإجمالي
            document.getElementById('total-villages').textContent = villageCount;
            document.getElementById('total-months').textContent = availableMonthsKeys.length;
            
            const totalRemaining = lastTotalRow[10] || 0;
            document.getElementById('total-remaining').textContent = totalRemaining.toLocaleString('ar-EG');
            
            document.getElementById('last-month').textContent = lastMonthKey;
        }

        // ===== الميزات الجديدة =====

        function toggleDarkMode() {
            const isDark = document.body.classList.toggle('dark-mode');
            
            if (isDark) {
                darkModeBtn.innerHTML = '<i class="fas fa-sun"></i> الوضع الفاتح';
                darkModeBtn.style.backgroundColor = '#ffc107';
                localStorage.setItem('darkMode', 'enabled');
            } else {
                darkModeBtn.innerHTML = '<i class="fas fa-moon"></i> الوضع الداكن';
                darkModeBtn.style.backgroundColor = '#343a40';
                localStorage.setItem('darkMode', 'disabled');
            }
        }

        function toggleHighContrast() {
            const isEnabled = document.body.classList.toggle('high-contrast');
            const btn = document.getElementById('contrastBtn');
            
            if (isEnabled) {
                btn.innerHTML = '<i class="fas fa-adjust"></i> الوضع الطبيعي';
                btn.style.backgroundColor = '#343a40';
                localStorage.setItem('highContrast', 'enabled');
            } else {
                btn.innerHTML = '<i class="fas fa-adjust"></i> وضع عالي التباين';
                btn.style.backgroundColor = '#5a6268';
                localStorage.setItem('highContrast', 'disabled');
            }
        }
        
        function exportBackup() {
            const data = {
                village: villageSelect.value,
                month: monthSelect.value,
                data: dataManager.currentData,
                metrics: dataManager.metrics,
                timestamp: new Date().toISOString(),
                version: '2.0'
            };
            
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", `backup_${villageSelect.value}_${monthSelect.value}_${Date.now()}.json`);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            
            showSaveNotification(true, 'تم تصدير النسخة الاحتياطية');
            showToast('تم تصدير النسخة الاحتياطية بنجاح', 'success');
        }
        
        function showSystemInfo() {
            const modal = document.getElementById('systemInfoModal');
            const content = document.getElementById('systemInfoContent');
            
            content.innerHTML = `
                <div style="margin: 20px 0;">
                    <h4 style="color: var(--primary); margin-bottom: 15px;">⚙️ معلومات النظام</h4>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                        <div style="background: rgba(0, 119, 182, 0.1); padding: 15px; border-radius: 8px;">
                            <div style="font-size: 0.9rem; color: var(--text-light);">النظام</div>
                            <div style="font-weight: bold;">إدارة مياه السوفعي</div>
                        </div>
                        <div style="background: rgba(40, 167, 69, 0.1); padding: 15px; border-radius: 8px;">
                            <div style="font-size: 0.9rem; color: var(--text-light);">الإصدار</div>
                            <div style="font-weight: bold;">2.0</div>
                        </div>
                        <div style="background: rgba(108, 117, 125, 0.1); padding: 15px; border-radius: 8px;">
                            <div style="font-size: 0.9rem; color: var(--text-light);">القرى</div>
                            <div style="font-weight: bold;">8 قرى</div>
                        </div>
                        <div style="background: rgba(255, 193, 7, 0.1); padding: 15px; border-radius: 8px;">
                            <div style="font-size: 0.9rem; color: var(--text-light);">الحالة</div>
                            <div style="font-weight: bold; color: ${navigator.onLine ? 'var(--success)' : 'var(--danger)'}">
                                ${navigator.onLine ? 'متصل بالإنترنت' : 'غير متصل'}
                            </div>
                        </div>
                    </div>
                    
                    <h5 style="color: var(--primary); margin: 15px 0;">الميزات الأساسية:</h5>
                    <ul style="list-style: none; padding: 0; margin: 0 0 20px 0;">
                        <li style="padding: 8px 0; border-bottom: 1px solid rgba(0,0,0,0.1);">
                            <i class="fas fa-check-circle" style="color: var(--success);"></i> إدخال القراءات
                        </li>
                        <li style="padding: 8px 0; border-bottom: 1px solid rgba(0,0,0,0.1);">
                            <i class="fas fa-check-circle" style="color: var(--success);"></i> حساب الفواتير
                        </li>
                        <li style="padding: 8px 0; border-bottom: 1px solid rgba(0,0,0,0.1);">
                            <i class="fas fa-check-circle" style="color: var(--success);"></i> متابعة التحصيل
                        </li>
                        <li style="padding: 8px 0; border-bottom: 1px solid rgba(0,0,0,0.1);">
                            <i class="fas fa-check-circle" style="color: var(--success);"></i> تقارير شاملة
                        </li>
                        <li style="padding: 8px 0;">
                            <i class="fas fa-check-circle" style="color: var(--success);"></i> عمل بدون إنترنت
                        </li>
                    </ul>
                    
                    <div style="background: rgba(220, 53, 69, 0.1); padding: 15px; border-radius: 8px; margin-top: 20px;">
                        <div style="font-size: 0.9rem; color: var(--text-light);">المهام المعلقة</div>
                        <div style="font-size: 1.2rem; font-weight: bold; color: var(--danger);" id="systemPendingTasks">جاري التحميل...</div>
                    </div>
                    
                    <div style="margin-top: 20px; font-size: 0.9rem; color: var(--text-light); text-align: center;">
                        آخر تحديث: ${new Date().toLocaleString('ar-SA')}
                    </div>
                </div>
            `;
            
            // تحميل عدد المهام المعلقة
            syncManager.getPendingTasksFromDB().then(tasks => {
                const tasksElement = document.getElementById('systemPendingTasks');
                if (tasksElement) {
                    tasksElement.textContent = tasks.length;
                }
            });
            
            modal.classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function showExportModal() {
            const modal = document.getElementById('exportModal');
            modal.classList.add('active');
        }

        function exportAsExcel() {
            showToast('جاري تصدير البيانات بصيغة Excel...', 'info');
            setTimeout(() => {
                window.open('https://script.google.com/macros/s/AKfycby5t4c0M4tK1k8R6GvR-e9D3QhT1qQ_t5XnF6X1A_9I4K0X3K0B/exec', '_blank');
                closeModal('exportModal');
            }, 1000);
        }

        function exportAsJSON() {
            const data = {
                village: villageSelect.value,
                month: monthSelect.value,
                data: dataManager.currentData,
                metrics: dataManager.metrics,
                timestamp: new Date().toISOString()
            };
            
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", `data_${villageSelect.value}_${monthSelect.value}.json`);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            
            closeModal('exportModal');
            showToast('تم تصدير البيانات بصيغة JSON', 'success');
        }

        function exportAsCSV() {
            const data = dataManager.currentData;
            if (!data || data.length === 0) {
                showToast('لا توجد بيانات للتصدير', 'error');
                return;
            }

            const csvContent = data.map(row => 
                row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')
            ).join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", url);
            downloadAnchorNode.setAttribute("download", `data_${villageSelect.value}_${monthSelect.value}.csv`);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            
            closeModal('exportModal');
            showToast('تم تصدير البيانات بصيغة CSV', 'success');
        }

        function exportAsPDF() {
            showToast('هذه الميزة تحت التطوير حالياً', 'info');
            // يمكن إضافة مكتبة jsPDF هنا لإنشاء ملفات PDF
        }

        function clearCache() {
            if (confirm('هل أنت متأكد من مسح ذاكرة التخزين المؤقت؟ سيتم حذف جميع البيانات المحلية.')) {
                // تنظيف جميع المؤقتات أولاً
                memoryMonitor.cleanupAllTimers();
                dataManager.stopAutoRefresh();
                focusManager.cleanup();
                syncManager.cleanup();
                
                // إغلاق قاعدة البيانات
                if (db) {
                    db.close();
                    db = null;
                }
                
                indexedDB.deleteDatabase(DB_NAME);
                localStorage.clear();
                sessionStorage.clear();
                
                showToast('تم مسح ذاكرة التخزين المؤقت بنجاح', 'success');
                setTimeout(() => {
                    location.reload();
                }, 2000);
            }
        }

        function updatePerformanceStats() {
            if (performance.memory) {
                const memoryMB = Math.round(performance.memory.usedJSHeapSize / (1024 * 1024));
                const memoryElement = document.getElementById('memoryUsage');
                if (memoryElement) {
                    memoryElement.textContent = memoryMB;
                }
            }
            
            const loadTime = Math.round(performance.now());
            const loadTimeElement = document.getElementById('loadTime');
            if (loadTimeElement) {
                loadTimeElement.textContent = loadTime;
            }
        }

        function switchFeature(featureName) {
            document.querySelectorAll('.feature-content').forEach(content => {
                content.classList.remove('active');
            });
            
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            const contentElement = document.getElementById(`${featureName}-content`);
            const buttonElement = document.querySelector(`.tab-button[data-feature="${featureName}"]`);
            
            if (contentElement) contentElement.classList.add('active');
            if (buttonElement) buttonElement.classList.add('active');
            
            if (featureName === 'monthly-report') {
                fetchMonthlyReportData();
            }
            
            // تنظيف الذاكرة عند تبديل الميزات
            setTimeout(() => memoryMonitor.forceCleanup(), 500);
        }

        // ===== التهيئة الرئيسية المحسنة =====

        document.addEventListener("DOMContentLoaded", async function() {
            try {
                const startTime = performance.now();
                
                toggleAlertsBtn = document.getElementById('toggleAlertsBtn');

                // فتح قاعدة البيانات
                db = await openDatabase();
                console.log('✅ تم فتح قاعدة البيانات بنجاح');

                // تنظيف الأخطاء القديمة
                await ErrorLogger.clearOldErrors(30);

                // إعداد أحداث الاتصال
                window.addEventListener('online', updateOnlineStatus);
                window.addEventListener('offline', updateOnlineStatus);
                
                // تحديث حالة الاتصال الحالية
                updateOnlineStatus();

                // إعداد أحداث البحث
                searchInput.addEventListener('input', function() {
                    if (this.timer) {
                        clearTimeout(this.timer);
                    }
                    this.timer = setTimeout(() => dataManager.applyFiltersAndSearch(), 300);
                });

                // إعداد أحداث التحديث
                villageSelect.addEventListener('change', () => {
                    aiAnalysisSection.style.display = 'none';
                    dataManager.loadData(true);
                });
                
                monthSelect.addEventListener('change', () => {
                    aiAnalysisSection.style.display = 'none';
                    dataManager.loadData(true);
                });

                // زر إظهار المتأخرين
                toggleLateBalancesBtn.addEventListener('click', () => {
                    dataManager.toggleLateBalances();
                });

                // ضبط الشهر الافتراضي
                setDefaultMonth();
                
                // تحميل الإعدادات المحفوظة
                const darkMode = localStorage.getItem('darkMode');
                if (darkMode === 'enabled') {
                    document.body.classList.add('dark-mode');
                    darkModeBtn.innerHTML = '<i class="fas fa-sun"></i> الوضع الفاتح';
                    darkModeBtn.style.backgroundColor = '#ffc107';
                }
                
                const highContrast = localStorage.getItem('highContrast');
                if (highContrast === 'enabled') {
                    document.body.classList.add('high-contrast');
                    const contrastBtn = document.getElementById('contrastBtn');
                    if (contrastBtn) {
                        contrastBtn.innerHTML = '<i class="fas fa-adjust"></i> الوضع الطبيعي';
                        contrastBtn.style.backgroundColor = '#343a40';
                    }
                }
                
                // تحميل البيانات الأولية
                dataManager.loadData();
                
                // تفعيل التحديث التلقائي
                autoRefreshToggle();

                // تحديث واجهة المزامنة
                syncManager.updateSyncUI();
                
                // تحديث إحصائيات الأداء
                const endTime = performance.now();
                updatePerformanceStats();
                
                console.log('✅ تم تهيئة النظام بنجاح');
                showToast('تم تحميل النظام بنجاح', 'success', 3000);
                
            } catch (error) {
                console.error("خطأ في التهيئة:", error);
                ErrorLogger.log(error, { action: 'initialization' });
                updateStatus('خطأ في التهيئة', false, true);
                showSaveNotification(false, 'خطأ في تهيئة النظام. يرجى تحديث الصفحة.');
                showToast('خطأ في تهيئة النظام', 'error');
            }
        });

        // إغلاق النوافذ المنبثقة عند النقر خارجها
        document.addEventListener('click', (event) => {
            const modals = document.querySelectorAll('.modal-overlay');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });

        // تسجيل أي أخطاء غير معالجة
        window.addEventListener('error', (event) => {
            ErrorLogger.log(event.error, { 
                action: 'unhandledError',
                filename: event.filename,
                lineno: event.lineno,
                colno: event.colno 
            });
        });

        // تسجيل أخطاء الوعود غير المعالجة
        window.addEventListener('unhandledrejection', (event) => {
            ErrorLogger.log(event.reason, { 
                action: 'unhandledRejection'
            });
        });

        // تنظيف الذاكرة عند إغلاق الصفحة
        window.addEventListener('beforeunload', () => {
            memoryMonitor.stopMonitoring();
            dataManager.stopAutoRefresh();
            dataManager.cleanup();
            syncManager.cleanup();
            focusManager.cleanup();
        });

        // تنظيف الذاكرة عند إخفاء الصفحة
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                memoryMonitor.pauseCharts();
            } else {
                memoryMonitor.resumeCharts();
            }
        });
    </script>
</body>
</html>چ